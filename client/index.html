<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Poulailler Pro - Système Avancé avec Google Sheets</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Enhanced Authentication Styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease-out;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.05), transparent);
            animation: shimmer 3s infinite;
        }

        .auth-container h1 {
            color: #343a40;
            margin-bottom: 10px;
            font-size: 2rem;
            position: relative;
            z-index: 1;
        }

        .auth-container p {
            color: #6c757d;
            margin-bottom: 30px;
            font-size: 1rem;
            position: relative;
            z-index: 1;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .auth-input {
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
            position: relative;
        }

        .auth-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .auth-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .auth-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .auth-button:hover::before {
            left: 100%;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            font-weight: 500;
            display: none;
            position: relative;
            z-index: 1;
        }

        .auth-users {
            margin-top: 20px;
            padding: 20px;
            background: rgba(23, 162, 184, 0.1);
            border-radius: 10px;
            border-left: 4px solid #17a2b8;
            position: relative;
            z-index: 1;
        }

        .auth-users h4 {
            color: #17a2b8;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .auth-users ul {
            list-style: none;
            text-align: left;
        }

        .auth-users li {
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        .user-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 2px solid rgba(40, 167, 69, 0.2);
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logout-btn {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(220, 53, 69, 0.2);
            transform: scale(1.05);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Hide main content initially */
        .main-content {
            display: none;
        }

        .main-content.authenticated {
            display: block;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #ff6b6b, #ffa500);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
            --border-radius: 15px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            color: var(--dark-color);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 25px;
            box-shadow: var(--shadow);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: var(--secondary-gradient);
            color: #ffffff;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="10" height="10" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            animation: float 20s infinite linear;
            pointer-events: none;
        }

        @keyframes float {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 30px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .connection-status.connected {
            background: rgba(40, 167, 69, 0.2);
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(220, 53, 69, 0.2);
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .setup-section {
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05));
            padding: 30px;
            margin: 20px;
            border-radius: var(--border-radius);
            border: 2px solid var(--info-color);
        }

        .setup-section h3 {
            color: var(--info-color);
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .setup-instructions {
            background: var(--white);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--info-color);
        }

        .setup-instructions ol {
            margin-left: 20px;
            line-height: 1.6;
        }

        .setup-instructions li {
            margin-bottom: 8px;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: rgba(255,255,255,0.1);
            margin-top: 20px;
        }

        .quick-stat {
            text-align: center;
            color: var(--white);
        }

        .quick-stat .number {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }

        .quick-stat .label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .tabs {
            display: flex;
            background: var(--light-color);
            border-bottom: 3px solid #e9ecef;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 20px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: var(--transition);
            position: relative;
            white-space: nowrap;
        }

        .tab:hover {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }

        .tab.active {
            color: #ff6b6b;
            background: var(--white);
            transform: translateY(-2px);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--secondary-gradient);
            border-radius: 2px 2px 0 0;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .info-card {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            transform: translateY(0);
            transition: var(--transition);
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--secondary-gradient);
        }

        .info-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
        }

        .info-card h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--dark-color);
            font-weight: 600;
        }

        .info-card .value {
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: var(--secondary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .info-card small {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .table-container {
            background: var(--white);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .table-header {
            background: var(--secondary-gradient);
            color: var(--white);
            padding: 25px 30px;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.95rem;
            vertical-align: middle;
        }
        
        td:last-child {
            width: 1%;
            white-space: nowrap;
        }

        th {
            background: var(--light-color);
            font-weight: 600;
            color: var(--dark-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody tr {
            transition: var(--transition);
        }

        tbody tr:hover {
            background: rgba(255, 107, 107, 0.05);
        }

        .input-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,249,250,0.9));
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            border: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
        }
        
        .input-section h3 {
            font-size: 1.5rem;
            color: var(--dark-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        .input-field label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.95rem;
        }

        .input-field input, 
        .input-field select, 
        .input-field textarea {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: var(--transition);
            background: var(--white);
            color: var(--dark-color);
        }

        .input-field input:focus, 
        .input-field select:focus,
        .input-field textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            padding: 10px 20px;
            background: var(--secondary-gradient);
            color: var(--white);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            margin: 0 5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-full-width {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            margin: 0;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #218838);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #138496);
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .summary-section {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 40px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .summary-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
            animation: float 15s infinite linear reverse;
            pointer-events: none;
        }

        .summary-section h3 {
            font-size: 1.8rem;
            margin-bottom: 25px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            position: relative;
            z-index: 1;
        }

        .summary-item {
            text-align: center;
            padding: 25px 20px;
            background: rgba(255,255,255,0.15);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: var(--transition);
        }

        .summary-item:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-5px);
        }

        .summary-item .label {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .summary-item .value {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .alert {
            padding: 20px;
            margin-bottom: 25px;
            border-radius: var(--border-radius);
            font-weight: 500;
            border-left: 5px solid;
            position: relative;
            overflow: hidden;
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            animation: shimmer 2s infinite;
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            color: #155724;
            border-left-color: var(--success-color);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border-left-color: var(--warning-color);
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            color: #721c24;
            border-left-color: var(--danger-color);
        }

        .alert-info {
            background: rgba(23, 162, 184, 0.1);
            color: #0c5460;
            border-left-color: var(--info-color);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
        }

        .status-inactive {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .connection-status {
                position: static;
                margin-top: 15px;
                display: inline-block;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .info-cards {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .input-group {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                text-align: center;
                margin: 5px 0;
            }

            .user-badge {
                position: relative;
                top: auto;
                right: auto;
                margin: 10px auto;
                display: block;
                text-align: center;
                width: fit-content;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: auto;
                width: 100%;
            }
        }

        /* Enhanced visual effects */
        .production-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .production-summary > div {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: var(--transition);
        }

        .production-summary > div:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .pricing-tiers {
            background: rgba(23, 162, 184, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid rgba(23, 162, 184, 0.2);
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .pricing-tier {
            padding: 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }

        .pricing-tier.active-tier {
            border-color: #17a2b8;
            background: rgba(23, 162, 184, 0.1);
            transform: scale(1.02);
        }

        .feed-analysis {
            background: rgba(40, 167, 69, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid rgba(40, 167, 69, 0.2);
            display: none;
        }

        .production-table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .enhanced-input {
            position: relative;
        }

        .enhanced-input input:focus + .input-hint {
            opacity: 1;
            transform: translateY(0);
        }

        .input-hint {
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 10;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .container {
                background: #1a1a1a;
                color: #e0e0e0;
            }
            
            .input-field input, 
            .input-field select, 
            .input-field textarea {
                background: #2d2d2d;
                border-color: #444;
                color: #e0e0e0;
            }
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus indicators */
        .btn:focus,
        .tab:focus {
            outline: 2px solid #ff6b6b;
            outline-offset: 2px;
        }

        /* Print styles */
        @media print {
            .auth-overlay,
            .user-badge,
            .btn,
            .tabs {
                display: none !important;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-container">
            <h1>🐔 Accès Sécurisé</h1>
            <p>Système de Gestion Poulailler Pro</p>
            
            <form class="auth-form" onsubmit="authenticateUser(event)">
                <input 
                    type="text" 
                    id="username" 
                    class="auth-input" 
                    placeholder="Nom d'utilisateur" 
                    required
                    autocomplete="username"
                    aria-label="Nom d'utilisateur"
                >
                <input 
                    type="password" 
                    id="password" 
                    class="auth-input" 
                    placeholder="Mot de passe" 
                    required
                    autocomplete="current-password"
                    aria-label="Mot de passe"
                >
                <button type="submit" class="auth-button" id="loginBtn">
                    🔓 Se Connecter
                </button>
            </form>
            
            <div id="authError" class="auth-error" role="alert">
                Identifiants incorrects. Veuillez réessayer.
            </div>
            
            <div class="auth-users">
                <h4>👥 Utilisateurs Autorisés :</h4>
                <ul>
                    <li>• Gestionnaire Principal (Accès Complet)</li>
                    <li>• Laye - Directeur Général (Accès Complet)</li>
                    <li>• Matar - Directeur des Opérations (Accès Complet)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Main Application Content -->
    <div class="main-content" id="mainContent">
        <!-- User Badge -->
        <div class="user-badge" id="userBadge">
            👤 <span id="currentUser">Utilisateur</span>
            <button class="logout-btn" onclick="logoutUser()">Déconnexion</button>
        </div>

        <div class="container">
            <div class="header">
                <div class="connection-status" id="connectionStatus">
                    <span class="loading-spinner"></span> Connexion en cours...
                </div>
                <h1>🐔 Gestion Poulailler Pro</h1>
                <p>Système Avancé avec Google Sheets Integration</p>
                <div class="quick-stats">
                    <div class="quick-stat">
                        <span class="number" id="headerTotalPoules">-</span>
                        <span class="label">Poules Total</span>
                    </div>
                    <div class="quick-stat">
                        <span class="number" id="headerProduction">-</span>
                        <span class="label">Œufs/Mois</span>
                    </div>
                    <div class="quick-stat">
                        <span class="number" id="headerROI">-</span>
                        <span class="label">ROI Actuel</span>
                    </div>
                    <div class="quick-stat">
                        <span class="number" id="headerProfitability">-</span>
                        <span class="label">FCFA/Œuf</span>
                    </div>
                </div>
            </div>

            <!-- Configuration Google Sheets -->
            <div class="setup-section" id="setupSection">
                <h3>🔗 Configuration Google Sheets</h3>
                <div class="setup-instructions">
                    <h4>Instructions de Configuration :</h4>
                    <ol>
                        <li>Créez un nouveau Google Sheets avec les onglets suivants : "Production", "Ventes", "Investissements", "Inventaire", "Sante"</li>
                        <li>Partagez votre feuille avec "Modifier pour tous ceux qui ont le lien"</li>
                        <li>Copiez l'ID de votre feuille depuis l'URL (entre /d/ et /edit)</li>
                        <li>Collez l'ID ci-dessous et cliquez sur "Connecter"</li>
                    </ol>
                </div>
                <div class="input-group">
                    <div class="input-field">
                        <label for="sheetId">ID Google Sheets</label>
                        <input type="text" id="sheetId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms" aria-describedby="sheetIdHelp" />
                        <small id="sheetIdHelp" class="sr-only">Entrez l'ID de votre feuille Google Sheets</small>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" onclick="connectToSheets()">🔗 Connecter aux Google Sheets</button>
                    <button class="btn btn-info" onclick="initializeSheets()">📋 Initialiser les Feuilles</button>
                    <button class="btn btn-secondary" onclick="testConnection()">🧪 Tester la Connexion</button>
                    <button class="btn btn-info" onclick="showHelp()">❓ Aide & Guide</button>
                </div>
            </div>

            <div class="tabs" role="tablist">
                <button class="tab active" role="tab" aria-selected="true" onclick="switchTab(0)">📝 Saisie Quotidienne</button>
                <button class="tab" role="tab" aria-selected="false" onclick="switchTab(1)">📊 Tableau de Bord</button>
                <button class="tab" role="tab" aria-selected="false" onclick="switchTab(2)">💰 Investissements</button>
                <button class="tab" role="tab" aria-selected="false" onclick="switchTab(3)">📋 Inventaire</button>
                <button class="tab" role="tab" aria-selected="false" onclick="switchTab(4)">📚 Historiques</button>
                <button class="tab" role="tab" aria-selected="false" onclick="switchTab(5)">📈 Analyses</button>
                <button class="tab" role="tab" aria-selected="false" onclick="switchTab(6)">📑 Rapports</button>
            </div>

            <!-- Saisie Quotidienne -->
            <div class="tab-content active" role="tabpanel">
                <div class="input-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Journal du Jour</h2>
                        <input type="date" id="daily-log-date" style="padding: 10px 16px; border: 2px solid rgb(233, 236, 239); border-radius: 10px; font-size: 16px;" aria-label="Date du journal">
                    </div>

                    <h3>🥚 Production par Lot</h3>
                    <div class="production-table-container">
                        <div style="background: linear-gradient(135deg, #ff6b6b, #ffa500); color: white; padding: 15px 20px; font-weight: 600;">
                            📊 Suivi de Production Quotidienne - Tous les Lots
                        </div>
                        <table role="table">
                            <thead>
                                <tr>
                                    <th scope="col">Lot</th>
                                    <th scope="col">Effectif Actuel</th>
                                    <th scope="col">Œufs Collectés</th>
                                    <th scope="col">Œufs Cassés/Fêlés</th>
                                    <th scope="col">Taux de Ponte</th>
                                    <th scope="col">Mortalité</th>
                                    <th scope="col">Observations</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="lot1-row">
                                    <td>
                                        <div style="font-weight: 600; color: #495057;">Lot 1</div>
                                        <div style="font-size: 0.85rem; color: #6c757d;">Croissance (9 semaines)</div>
                                        <div style="font-size: 0.8rem; color: #17a2b8;">Démarré: 13/05/2025</div>
                                    </td>
                                    <td style="text-align: center;">
                                        <input type="number" id="lot1-effectif" value="960" style="width: 70px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 5px;" readonly aria-label="Effectif Lot 1">
                                        <button onclick="editEffectif('lot1')" style="margin-left: 5px; padding: 2px 6px; font-size: 0.8rem; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;" aria-label="Modifier effectif Lot 1">✏️</button>
                                    </td>
                                    <td style="text-align: center;">
                                        <input type="number" id="lot1-oeufs" placeholder="0" style="width: 80px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 8px;" oninput="calculatePonteRate('lot1')" aria-label="Œufs collectés Lot 1">
                                        <div style="font-size: 0.75rem; color: #6c757d; margin-top: 2px;">Pas encore en ponte</div>
                                    </td>
                                    <td style="text-align: center;">
                                        <input type="number" id="lot1-casses" placeholder="0" style="width: 70px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 8px;" aria-label="Œufs cassés Lot 1">
                                    </td>
                                    <td style="text-align: center;">
                                        <div id="lot1-taux" style="font-weight: bold; color: #6c757d; font-size: 1.1rem;" aria-label="Taux de ponte Lot 1">-</div>
                                        <div style="font-size: 0.75rem; color: #6c757d;">%</div>
                                    </td>
                                    <td style="text-align: center;">
                                        <input type="number" id="lot1-mortalite" placeholder="0" style="width: 70px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 8px;" onchange="updateEffectif('lot1')" aria-label="Mortalité Lot 1">
                                    </td>
                                    <td>
                                        <textarea id="lot1-observations" placeholder="Comportement, santé..." style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 8px; resize: vertical;" rows="2" aria-label="Observations Lot 1"></textarea>
                                    </td>
                                </tr>
                                <tr id="lot2-row">
                                    <td>
                                        <div style="font-weight: 600; color: #495057;">Lot 2</div>
                                        <div style="font-size: 0.85rem; color: #28a745;">Production (20 semaines)</div>
                                        <div style="font-size: 0.8rem; color: #17a2b8;">Démarré: 01/03/2025</div>
                                    </td>
                                    <td style="text-align: center;">
                                        <input type="number" id="lot2-effectif" value="500" style="width: 70px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 5px;" readonly aria-label="Effectif Lot 2">
                                        <button onclick="editEffectif('lot2')" style="margin-left: 5px; padding: 2px 6px; font-size: 0.8rem; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;" aria-label="Modifier effectif Lot 2">✏️</button>
                                    </td>
                                    <td style="text-align: center;">
                                        <input type="number" id="lot2-oeufs" placeholder="Ex: 360" style="width: 80px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 8px;" oninput="calculatePonteRate('lot2')" aria-label="Œufs collectés Lot 2">
                                        <div style="font-size: 0.75rem; color: #28a745; margin-top: 2px;">En production</div>
                                    </td>
                                    <td style="text-align: center;">
                                        <input type="number" id="lot2-casses" placeholder="Ex: 5" style="width: 70px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 8px;" aria-label="Œufs cassés Lot 2">
                                    </td>
                                    <td style="text-align: center;">
                                        <div id="lot2-taux" style="font-weight: bold; color: #28a745; font-size: 1.1rem;" aria-label="Taux de ponte Lot 2">-</div>
                                        <div style="font-size: 0.75rem; color: #6c757d;">%</div>
                                    </td>
                                    <td style="text-align: center;">
                                        <input type="number" id="lot2-mortalite" placeholder="0" style="width: 70px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 8px;" onchange="updateEffectif('lot2')" aria-label="Mortalité Lot 2">
                                    </td>
                                    <td>
                                        <textarea id="lot2-observations" placeholder="Comportement, santé..." style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 8px; resize: vertical;" rows="2" aria-label="Observations Lot 2"></textarea>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Production Summary -->
                    <div class="production-summary">
                        <div style="border-left-color: #28a745;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #28a745;" id="totalOeufsJour">-</div>
                            <div style="color: #6c757d; font-size: 0.9rem;">Total Œufs du Jour</div>
                        </div>
                        <div style="border-left-color: #ffc107;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #ffc107;" id="totalCassesJour">-</div>
                            <div style="color: #6c757d; font-size: 0.9rem;">Total Œufs Cassés</div>
                        </div>
                        <div style="border-left-color: #17a2b8;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #17a2b8;" id="tauxMoyenJour">-</div>
                            <div style="color: #6c757d; font-size: 0.9rem;">Taux Moyen Global (%)</div>
                        </div>
                        <div style="border-left-color: #dc3545;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #dc3545;" id="totalMortaliteJour">-</div>
                            <div style="color: #6c757d; font-size: 0.9rem;">Total Mortalité</div>
                        </div>
                    </div>

                    <h3>🌾 Alimentation</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="alim-type">Type d'aliment</label>
                            <select id="alim-type" onchange="updateFeedInfo()" aria-describedby="alim-type-help">
                                <option value="ponte">Ponte (adultes producteurs)</option>
                                <option value="croissance">Croissance (jeunes poules)</option>
                                <option value="demarrage">Démarrage (poussins)</option>
                                <option value="finition">Finition (avant vente)</option>
                            </select>
                            <small id="alim-type-help" class="sr-only">Sélectionnez le type d'aliment adapté à l'âge des poules</small>
                        </div>
                        <div class="input-field">
                            <label for="alim-sacs">Nombre de sacs</label>
                            <input type="number" id="alim-sacs" placeholder="Ex: 3" oninput="calculateFeedTotal()" min="0" step="1">
                        </div>
                        <div class="input-field">
                            <label for="alim-poids-sac">Poids par sac (kg)</label>
                            <input type="number" id="alim-poids-sac" placeholder="Ex: 50" value="50" oninput="calculateFeedTotal()" min="1" step="0.1">
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="alim-prix-sac">Prix par sac (FCFA)</label>
                            <input type="number" id="alim-prix-sac" placeholder="Ex: 25000" oninput="calculateFeedTotal()" min="0" step="100">
                        </div>
                        <div class="input-field">
                            <label for="alim-qte-totale">Quantité totale (kg)</label>
                            <input type="number" id="alim-qte-totale" readonly style="background: #f8f9fa; font-weight: bold;" tabindex="-1">
                        </div>
                        <div class="input-field">
                            <label for="alim-cout-total">Coût total (FCFA)</label>
                            <input type="number" id="alim-cout-total" readonly style="background: #e9ecef; font-weight: bold; font-size: 1.1rem;" tabindex="-1">
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="alim-lot">Lot(s) concerné(s)</label>
                            <select id="alim-lot" multiple style="height: 80px;" aria-describedby="alim-lot-help">
                                <option value="lot1">Lot 1 (Croissance - 960 poules)</option>
                                <option value="lot2">Lot 2 (Production - 500 poules)</option>
                                <option value="tous">Tous les lots</option>
                            </select>
                            <small id="alim-lot-help" style="color: #6c757d;">Maintenez Ctrl/Cmd pour sélectionner plusieurs lots</small>
                        </div>
                        <div class="input-field">
                            <label for="alim-fournisseur">Fournisseur</label>
                            <input type="text" id="alim-fournisseur" placeholder="Nom du fournisseur">
                        </div>
                        <div class="input-field">
                            <label for="alim-notes">Notes (Optionnel)</label>
                            <textarea id="alim-notes" rows="2" placeholder="Qualité, conditions de stockage, etc..."></textarea>
                        </div>
                    </div>

                    <!-- Feed Cost Analysis -->
                    <div class="feed-analysis" id="feedAnalysis">
                        <h4 style="color: #28a745; margin-bottom: 15px;">📊 Analyse des Coûts d'Alimentation</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;" id="costPerKg">-</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">FCFA/kg</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;" id="costPerPoule">-</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">FCFA/poule/jour (estimé)</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;" id="feedDuration">-</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">Jours d'alimentation</div>
                            </div>
                        </div>
                    </div>

                    <h3>💸 Ventes</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="sales-base-price">Prix de référence par tablette (FCFA)</label>
                            <input type="number" id="sales-base-price" placeholder="Ex: 2500" value="2500" oninput="updatePricingTiers()" min="1000" step="50">
                            <small style="color: #6c757d;">Prix de base pour calcul des paliers de remise</small>
                        </div>
                        <div class="input-field">
                            <label for="sales-trays">Tablettes vendues (de 30 œufs)</label>
                            <input type="number" id="sales-trays" placeholder="Nombre de tablettes" oninput="updateSalesCalculations()" min="0" step="1">
                        </div>
                        <div class="input-field">
                            <label for="sales-price">Prix de vente par tablette (FCFA)</label>
                            <input type="number" id="sales-price" placeholder="Entrez le prix de vente" oninput="calculateTotal()" min="0" step="50">
                            <small id="bulk-info" style="color: #17a2b8; font-weight: 600;"></small>
                        </div>
                    </div>
                    <div class="input-group">
                         <div class="input-field">
                            <label for="sales-client">Client (Optionnel)</label>
                            <input type="text" id="sales-client" placeholder="Nom du client">
                        </div>
                        <div class="input-field">
                            <label for="sales-total">Montant Total (FCFA)</label>
                            <input type="number" id="sales-total" readonly style="background: #e9ecef; font-weight: bold; font-size: 1.1rem;" tabindex="-1">
                        </div>
                    </div>
                    
                    <!-- Dynamic Pricing Tiers Display -->
                    <div class="pricing-tiers">
                        <h4 style="color: #17a2b8; margin-bottom: 15px;">📊 Guide Tarifaire par Volume (Référence)</h4>
                        <div id="pricing-grid" class="pricing-grid">
                            <!-- Pricing tiers will be populated dynamically -->
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border-left: 4px solid #ffc107;">
                            <small style="color: #856404; font-weight: 600;">
                                💡 Guide des prix suggérés - Vous pouvez appliquer un prix différent selon la négociation
                            </small>
                        </div>
                    </div>

                    <h3>🏥 Santé & Mortalité</h3>
                     <div class="input-group">
                        <div class="input-field">
                            <label for="sante-mortalite">Mortalité (nombre)</label>
                            <input type="number" id="sante-mortalite" placeholder="Nombre de sujets perdus" min="0" step="1">
                        </div>
                        <div class="input-field">
                            <label for="sante-notes">Observations Générales</label>
                            <textarea id="sante-notes" rows="2" placeholder="Comportement, symptômes, etc..."></textarea>
                        </div>
                    </div>

                    <button class="btn btn-success btn-full-width" onclick="saveDailyLog()">💾 Enregistrer la Journée</button>
                </div>
            </div>

            <!-- Tableau de Bord -->
            <div class="tab-content" role="tabpanel">
                <div class="info-cards">
                    <div class="info-card">
                        <h3>Total Poules Actives</h3>
                        <div class="value" id="totalPoules">-</div>
                        <small>Chargement...</small>
                    </div>
                    <div class="info-card">
                        <h3>Production Journalière</h3>
                        <div class="value" id="prodJournaliere">-</div>
                        <small>Chargement...</small>
                    </div>
                     <div class="info-card">
                        <h3>Revenus du Jour</h3>
                        <div class="value" id="revenusJour">-</div>
                        <small>Chargement...</small>
                    </div>
                    <div class="info-card">
                        <h3>Efficacité Alimentaire</h3>
                        <div class="value" id="efficaciteAlimentaire">-</div>
                        <small>Chargement...</small>
                    </div>
                    <div class="info-card">
                        <h3>Coût Production/Jour</h3>
                        <div class="value" id="coutJour">-</div>
                        <small>FCFA</small>
                    </div>
                </div>

                <div class="summary-section">
                    <h3>Résumé des Lots & Performance</h3>
                    <div class="summary-grid" id="summaryGrid">
                        <div class="summary-item">
                            <div class="label">Chargement des données...</div>
                            <div class="value">-</div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info" role="alert">
                    <strong>📊 Données en temps réel:</strong> Les informations sont synchronisées avec Google Sheets et mises à jour automatiquement.
                </div>
            </div>

            <!-- Investissements -->
            <div class="tab-content" role="tabpanel">
                <div class="summary-section">
                    <h3>💰 Résumé des Investissements</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="label">Investissement Total</div>
                            <div class="value" id="investissementTotal">-</div>
                            <div class="label">FCFA</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Coût par Poule</div>
                            <div class="value" id="coutParPoule">-</div>
                            <div class="label">FCFA</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Amortissement/Mois</div>
                            <div class="value" id="amortissement">-</div>
                            <div class="label">FCFA (30 mois)</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Valeur Résiduelle</div>
                            <div class="value" id="valeurResiduelle">-</div>
                            <div class="label">FCFA (20%)</div>
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <h3>Ajouter un Investissement</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="inv-description">Description</label>
                            <input type="text" id="inv-description" placeholder="Ex: Achat de 100 mangeoires">
                        </div>
                        <div class="input-field">
                            <label for="inv-montant">Montant (FCFA)</label>
                            <input type="number" id="inv-montant" placeholder="Ex: 150000" min="0" step="1000">
                        </div>
                        <div class="input-field">
                            <label for="inv-categorie">Catégorie</label>
                            <select id="inv-categorie">
                                <option>Bâtiment</option>
                                <option>Matériel</option>
                                <option>Achat de Sujets</option>
                                <option>Frais Vétérinaires initiaux</option>
                                <option>Autre</option>
                            </select>
                        </div>
                        <div class="input-field">
                            <label for="inv-date">Date</label>
                            <input type="date" id="inv-date">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="saveInvestment()">💾 Ajouter Investissement</button>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <span>Liste des Investissements</span>
                        <button class="btn btn-info" onclick="loadInvestments()">🔄 Actualiser</button>
                    </div>
                    <table id="investmentsTable">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Catégorie</th>
                                <th>Montant (FCFA)</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px;">
                                    <div class="loading-spinner"></div> Chargement des données...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Inventaire -->
            <div class="tab-content" role="tabpanel">
                <!-- Stock de Tablettes Section -->
                <div class="summary-section">
                    <h3>📦 Stock de Tablettes Disponibles</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="label">Œufs en Stock</div>
                            <div class="value" id="stockOeufs">2580</div>
                            <div class="label">œufs individuels</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Tablettes Complètes</div>
                            <div class="value" id="stockTablettes">86</div>
                            <div class="label">de 30 œufs chacune</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Œufs Restants</div>
                            <div class="value" id="stockRestant">0</div>
                            <div class="label">non emballés</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Valeur du Stock</div>
                            <div class="value" id="valeurStock">215000</div>
                            <div class="label">FCFA (prix moyen)</div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Management -->
                <div class="input-section">
                    <h3>📊 Gestion du Stock de Tablettes</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="stock-adjustment">Ajustement du Stock (œufs)</label>
                            <input type="number" id="stock-adjustment" placeholder="Ex: +360 (nouvelle production) ou -180 (vente)" step="1">
                        </div>
                        <div class="input-field">
                            <label for="stock-reason">Motif de l'Ajustement</label>
                            <select id="stock-reason">
                                <option>Production du jour</option>
                                <option>Vente effectuée</option>
                                <option>Œufs cassés/perdus</option>
                                <option>Correction d'inventaire</option>
                                <option>Don/Échantillon</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="adjustStock()">📦 Mettre à Jour le Stock</button>
                </div>

                <!-- Alerts for Stock Levels -->
                <div id="stockAlerts" role="alert" aria-live="polite"></div>

                 <div class="table-container">
                    <div class="table-header">
                        <span>Inventaire Général</span>
                        <div class="table-actions">
                            <button class="btn btn-success" onclick="showInventoryModal()">➕ Ajouter Article</button>
                            <button class="btn btn-info" onclick="loadInventory()">🔄 Actualiser</button>
                        </div>
                    </div>
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Article</th>
                                <th>Catégorie</th>
                                <th>Quantité en Stock</th>
                                <th>Unité</th>
                                <th>Seuil d'Alerte</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                         <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="loading-spinner"></div> Chargement des données...
                                </td>
                            </tr>
                         </tbody>
                    </table>
                 </div>
            </div>
            
            <!-- Historiques -->
            <div class="tab-content" role="tabpanel">
                 <div class="table-container">
                     <div class="table-header">
                         <span>Historique des Ventes</span>
                         <button class="btn btn-info" onclick="loadSalesHistory()">🔄 Actualiser</button>
                     </div>
                     <table id="salesLogTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Tablettes Vendues</th>
                                <th>Œufs (Total)</th>
                                <th>Prix / Tablette</th>
                                <th>Revenu Total (FCFA)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                         <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="loading-spinner"></div> Chargement des données...
                                </td>
                            </tr>
                         </tbody>
                     </table>
                </div>
                <div class="table-container">
                     <div class="table-header">
                         <span>Historique de Production</span>
                         <button class="btn btn-info" onclick="loadProductionHistory()">🔄 Actualiser</button>
                     </div>
                     <table id="productionLogTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Lot</th>
                                <th>Œufs Collectés</th>
                                <th>Taux de Ponte</th>
                                <th>Pertes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                         <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    <div class="loading-spinner"></div> Chargement des données...
                                </td>
                            </tr>
                         </tbody>
                     </table>
                </div>
                <div class="table-container">
                    <div class="table-header">
                        <span>Historique Sanitaire</span>
                        <button class="btn btn-info" onclick="loadHealthHistory()">🔄 Actualiser</button>
                    </div>
                    <table id="healthLogTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Lot</th>
                                <th>Mortalité</th>
                                <th>Observations</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px;">
                                    <div class="loading-spinner"></div> Chargement des données...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analyses -->
            <div class="tab-content" role="tabpanel">
                <div class="info-cards">
                    <div class="info-card">
                        <h3>Coût par Œuf</h3>
                        <div class="value" id="coutParOeuf">-</div>
                        <small>FCFA (Alim + Amort.)</small>
                    </div>
                     <div class="info-card">
                        <h3>Prix de Vente / Œuf</h3>
                        <div class="value" id="prixVenteOeuf">-</div>
                        <small>FCFA (Moyenne)</small>
                    </div>
                     <div class="info-card">
                        <h3>Marge par Œuf</h3>
                        <div class="value" id="margeOeuf">-</div>
                        <small>FCFA (Basé sur moyenne)</small>
                    </div>
                     <div class="info-card">
                        <h3>Point Mort</h3>
                        <div class="value" id="pointMort">-</div>
                        <small>œufs/jour pour couvrir les coûts</small>
                    </div>
                </div>
                 <div class="alert alert-info" role="alert">
                    <strong>Analyse Financière:</strong> Les analyses de rentabilité sont calculées automatiquement à partir des données Google Sheets et mises à jour en temps réel.
                </div>
            </div>

            <!-- Rapports -->
            <div class="tab-content" role="tabpanel">
                 <div class="summary-section">
                    <h3>📑 Génération de Rapports</h3>
                    <p style="text-align:center; margin-bottom: 30px; opacity: 0.9;">Sélectionnez un type de rapport à générer et exporter.</p>
                    <div class="button-group" style="justify-content: center;">
                        <button class="btn btn-info" onclick="generateProductionReport()">📊 Rapport de Production Mensuel</button>
                        <button class="btn btn-info" onclick="generateFinancialReport()">💰 Rapport Financier Trimestriel</button>
                        <button class="btn btn-info" onclick="generateInventoryReport()">📋 Rapport d'Inventaire Complet</button>
                        <button class="btn btn-secondary" onclick="exportAllData()">📤 Exporter Toutes les Données (CSV)</button>
                    </div>
                </div>
                <div class="alert alert-info" role="alert">
                    <strong>💡 Astuce:</strong> Les rapports sont générés à partir des données Google Sheets en temps réel. Vous pouvez également accéder directement à vos feuilles Google pour des analyses personnalisées.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Authentication System with better security
        const AUTHORIZED_USERS = {
            'admin': {
                password: 'Poulailler2025!',
                name: 'Gestionnaire Principal',
                role: 'full_access'
            },
            'laye': {
                password: 'Production123!',
                name: 'Directeur Général', 
                role: 'full_access'
            },
            'matar': {
                password: 'Ventes456!',
                name: 'Directeur des Opérations',
                role: 'full_access'
            }
        };

        let currentUser = null;
        let sessionTimeout = null;
        const SESSION_DURATION = 8 * 60 * 60 * 1000; // 8 heures

        function authenticateUser(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.toLowerCase().trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('authError');
            
            // Disable button during authentication
            loginBtn.disabled = true;
            loginBtn.textContent = '🔄 Vérification...';
            
            // Simulate authentication delay for better UX
            setTimeout(() => {
                if (AUTHORIZED_USERS[username] && AUTHORIZED_USERS[username].password === password) {
                    // Successful authentication
                    currentUser = {
                        username: username,
                        name: AUTHORIZED_USERS[username].name,
                        role: AUTHORIZED_USERS[username].role,
                        loginTime: new Date().toISOString()
                    };
                    
                    // Save session with encryption simulation
                    const sessionData = {
                        user: currentUser,
                        expires: Date.now() + SESSION_DURATION,
                        token: generateSessionToken()
                    };
                    
                    localStorage.setItem('poultrySession', JSON.stringify(sessionData));
                    
                    // Show success and login
                    loginBtn.textContent = '✅ Connexion réussie!';
                    loginBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    
                    setTimeout(() => {
                        showMainApp();
                        logActivity('login', 'Connexion réussie');
                        showAlert(`Bienvenue ${currentUser.name}! Session active pour 8 heures.`, 'success');
                    }, 1000);
                    
                } else {
                    // Failed authentication
                    errorDiv.style.display = 'block';
                    loginBtn.disabled = false;
                    loginBtn.textContent = '🔓 Se Connecter';
                    loginBtn.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                    
                    // Reset form
                    document.getElementById('password').value = '';
                    document.getElementById('password').focus();
                    
                    // Log failed attempt
                    logActivity('failed_login', `Tentative échouée pour: ${username}`);
                    
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                        loginBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    }, 3000);
                }
            }, 1500);
        }

        function generateSessionToken() {
            return Math.random().toString(36).substring(2) + Date.now().toString(36);
        }

        function showMainApp() {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('mainContent').classList.add('authenticated');
            document.getElementById('currentUser').textContent = currentUser.name;
            
            // Set session timeout
            sessionTimeout = setTimeout(() => {
                showAlert('Session expirée. Reconnexion requise.', 'warning');
                logoutUser();
            }, SESSION_DURATION);
            
            // Initialize app
            initializeApp();
        }

        function logoutUser() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                // Clear session
                localStorage.removeItem('poultrySession');
                currentUser = null;
                
                if (sessionTimeout) {
                    clearTimeout(sessionTimeout);
                }
                
                // Log activity
                logActivity('logout', 'Déconnexion utilisateur');
                
                // Reset UI
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('mainContent').classList.remove('authenticated');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('authError').style.display = 'none';
                
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = false;
                loginBtn.textContent = '🔓 Se Connecter';
                loginBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            }
        }

        function checkExistingSession() {
            const session = localStorage.getItem('poultrySession');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    if (Date.now() < sessionData.expires && sessionData.token) {
                        currentUser = sessionData.user;
                        showMainApp();
                        showAlert(`Bon retour, ${currentUser.name}!`, 'success');
                        return true;
                    } else {
                        localStorage.removeItem('poultrySession');
                    }
                } catch (error) {
                    localStorage.removeItem('poultrySession');
                }
            }
            return false;
        }

        function logActivity(action, details) {
            const activity = {
                timestamp: new Date().toISOString(),
                user: currentUser ? currentUser.username : 'anonymous',
                action: action,
                details: details,
                sessionId: currentUser ? generateSessionToken().substring(0, 8) : 'none'
            };
            
            // Store in localStorage (in real app, send to server)
            const activities = JSON.parse(localStorage.getItem('poultryActivities') || '[]');
            activities.push(activity);
            
            // Keep only last 100 activities
            if (activities.length > 100) {
                activities.splice(0, activities.length - 100);
            }
            
            localStorage.setItem('poultryActivities', JSON.stringify(activities));
            console.log('Activity logged:', activity);
        }

        // Enhanced session monitoring
        function monitorSession() {
            setInterval(() => {
                if (currentUser) {
                    const session = localStorage.getItem('poultrySession');
                    if (!session) {
                        showAlert('Session invalidée. Reconnexion requise.', 'warning');
                        logoutUser();
                    } else {
                        try {
                            const sessionData = JSON.parse(session);
                            if (Date.now() >= sessionData.expires) {
                                showAlert('Session expirée. Reconnexion requise.', 'warning');
                                logoutUser();
                            }
                        } catch (error) {
                            logoutUser();
                        }
                    }
                }
            }, 60000); // Check every minute
        }

        // Initialize authentication
        function initializeAuth() {
            // Check for existing session
            if (!checkExistingSession()) {
                // Show login form
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('username').focus();
            }
            
            // Start session monitoring
            monitorSession();
            
            // Handle browser events
            window.addEventListener('beforeunload', () => {
                if (currentUser) {
                    logActivity('session_end', 'Fermeture navigateur/actualisation');
                }
            });
            
            document.addEventListener('visibilitychange', () => {
                if (currentUser) {
                    if (document.hidden) {
                        logActivity('tab_hidden', 'Onglet masqué');
                    } else {
                        logActivity('tab_visible', 'Onglet visible');
                    }
                }
            });

            // Add keyboard navigation for accessibility
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && currentUser) {
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.blur) {
                        activeElement.blur();
                    }
                }
            });
        }

        function initializeApp() {
            // Original initialization code with enhancements
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('daily-log-date').value = today;
            document.getElementById('inv-date').value = today;
            
            // Initialize stock and calculations
            updateEggStock();
            updatePricingTiers();
            
            // Check for saved sheet ID
            const savedSheetId = localStorage.getItem('poultrySheetId');
            if (savedSheetId) {
                document.getElementById('sheetId').value = savedSheetId;
                connectToSheets();
            }
            
            // Log successful app initialization
            logActivity('app_init', 'Application initialisée');
            
            // Set focus to first interactive element
            setTimeout(() => {
                const firstInput = document.querySelector('.tab-content.active input:not([readonly])');
                if (firstInput) firstInput.focus();
            }, 500);
        }

        // Initialize authentication when page loads
        document.addEventListener('DOMContentLoaded', initializeAuth);
        
        // Variables globales avec améliorations
        let isConnected = false;
        let currentSheetId = '';
        let currentEggStock = 2580; // Stock actuel d'œufs
        let basePricingTiers = {
            tier1: { min: 1, max: 49, discount: 0, name: 'Prix standard' },
            tier2: { min: 50, max: 99, discount: 4, name: 'Volume moyen' },
            tier3: { min: 100, max: 149, discount: 8, name: 'Gros volume' },
            tier4: { min: 150, max: Infinity, discount: 12, name: 'Volume industriel' }
        };
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Configuration de l'API Google Sheets
        const SHEETS_API_KEY = 'YOUR_API_KEY'; // À remplacer par votre clé API
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        
        // Enhanced form clearing with validation
        function clearDailyForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('daily-log-date').value = today;

            // Clear production fields for each lot
            ['lot1', 'lot2'].forEach(lotId => {
                document.getElementById(`${lotId}-oeufs`).value = '';
                document.getElementById(`${lotId}-casses`).value = '';
                document.getElementById(`${lotId}-mortalite`).value = '';
                document.getElementById(`${lotId}-observations`).value = '';
                document.getElementById(`${lotId}-taux`).textContent = '-';
                document.getElementById(`${lotId}-taux`).style.color = '#6c757d';
            });

            // Clear production summary
            document.getElementById('totalOeufsJour').textContent = '-';
            document.getElementById('totalCassesJour').textContent = '-';
            document.getElementById('tauxMoyenJour').textContent = '-';
            document.getElementById('totalMortaliteJour').textContent = '-';

            // Clear alimentation fields
            document.getElementById('alim-sacs').value = '';
            document.getElementById('alim-prix-sac').value = '';
            document.getElementById('alim-qte-totale').value = '';
            document.getElementById('alim-cout-total').value = '';
            document.getElementById('alim-fournisseur').value = '';
            document.getElementById('alim-notes').value = '';
            document.getElementById('alim-lot').selectedIndex = -1;
            document.getElementById('feedAnalysis').style.display = 'none';

            // Clear sales fields
            document.getElementById('sales-trays').value = '';
            document.getElementById('sales-price').value = '';
            document.getElementById('sales-total').value = '';
            document.getElementById('sales-client').value = '';
            document.getElementById('bulk-info').innerHTML = '';
            
            // Clear health fields
            document.getElementById('sante-mortalite').value = '';
            document.getElementById('sante-notes').value = '';

            showAlert('Formulaire réinitialisé pour une nouvelle saisie.', 'info');
        }
        
        // Enhanced navigation with accessibility
        function switchTab(index) {
            tabs.forEach((tab, i) => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
                tabContents[i].classList.remove('active');
            });

            tabs[index].classList.add('active');
            tabs[index].setAttribute('aria-selected', 'true');
            tabContents[index].classList.add('active');
            
            // Load data for active tab
            loadTabData(index);
            
            // Log tab navigation
            logActivity('tab_switch', `Onglet ${index} activé`);
            
            // Focus management for accessibility
            setTimeout(() => {
                const firstFocusable = tabContents[index].querySelector('input:not([readonly]), button, select, textarea');
                if (firstFocusable) firstFocusable.focus();
            }, 100);
        }

        function loadTabData(tabIndex) {
            if (!isConnected && tabIndex !== 0) {
                showAlert('Connectez-vous d\'abord à Google Sheets pour accéder aux données.', 'warning');
                return;
            }
            
            switch(tabIndex) {
                case 1: // Tableau de bord
                    loadDashboardData();
                    break;
                case 2: // Investissements
                    loadInvestments();
                    break;
                case 3: // Inventaire
                    loadInventory();
                    break;
                case 4: // Historiques
                    loadSalesHistory();
                    loadProductionHistory();
                    loadHealthHistory();
                    break;
                case 5: // Analyses
                    loadAnalysisData();
                    break;
            }
        }

        // Enhanced Google Sheets connection with error handling
        async function connectToSheets() {
            const sheetId = document.getElementById('sheetId').value.trim();
            if (!sheetId) {
                showAlert('Veuillez entrer un ID de feuille Google Sheets valide.', 'warning');
                return;
            }

            // Validate sheet ID format
            if (!/^[a-zA-Z0-9-_]+$/.test(sheetId)) {
                showAlert('Format d\'ID invalide. Vérifiez l\'ID de votre feuille Google Sheets.', 'danger');
                return;
            }

            updateConnectionStatus('connecting');
            
            try {
                // Enhanced connection simulation with realistic delay
                const testUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/edit`;
                
                setTimeout(() => {
                    currentSheetId = sheetId;
                    localStorage.setItem('poultrySheetId', sheetId);
                    isConnected = true;
                    updateConnectionStatus('connected');
                    hideSetupSection();
                    loadDashboardData();
                    showAlert('Connexion réussie ! Données synchronisées avec Google Sheets.', 'success');
                    logActivity('sheets_connected', `Connecté à la feuille: ${sheetId.substring(0, 8)}...`);
                }, 2000);
                
            } catch (error) {
                console.error('Erreur de connexion:', error);
                updateConnectionStatus('disconnected');
                showAlert('Erreur de connexion. Vérifiez l\'ID de la feuille et les permissions.', 'danger');
                logActivity('sheets_connection_failed', `Échec connexion: ${error.message}`);
            }
        }

        async function initializeSheets() {
            if (!currentSheetId) {
                showAlert('Veuillez d\'abord vous connecter à une feuille Google Sheets.', 'warning');
                return;
            }

            try {
                showAlert('Initialisation des feuilles en cours...', 'info');
                logActivity('sheets_init_start', 'Début initialisation feuilles');
                
                setTimeout(() => {
                    showAlert('Feuilles initialisées avec succès ! Les onglets Production, Ventes, Investissements, Inventaire et Sante ont été créés.', 'success');
                    logActivity('sheets_init_complete', 'Feuilles initialisées avec succès');
                }, 3000);
                
            } catch (error) {
                console.error('Erreur d\'initialisation:', error);
                showAlert('Erreur lors de l\'initialisation des feuilles.', 'danger');
                logActivity('sheets_init_failed', `Échec initialisation: ${error.message}`);
            }
        }

        async function testConnection() {
            const sheetId = document.getElementById('sheetId').value.trim();
            if (!sheetId) {
                showAlert('Veuillez entrer un ID de feuille.', 'warning');
                return;
            }

            try {
                showAlert('Test de connexion en cours...', 'info');
                logActivity('connection_test', `Test connexion pour: ${sheetId.substring(0, 8)}...`);
                
                setTimeout(() => {
                    showAlert('Test réussi ! La feuille Google Sheets est accessible.', 'success');
                    logActivity('connection_test_success', 'Test de connexion réussi');
                }, 1500);
                
            } catch (error) {
                showAlert('Test échoué. Vérifiez l\'ID et les permissions de partage.', 'danger');
                logActivity('connection_test_failed', `Test échoué: ${error.message}`);
            }
        }

        // Enhanced pricing calculation with better validation
        function updatePricingTiers() {
            const basePrice = parseFloat(document.getElementById('sales-base-price').value) || 2500;
            const pricingGrid = document.getElementById('pricing-grid');
            const currentQuantity = parseInt(document.getElementById('sales-trays').value) || 0;
            
            let tiersHtml = '';
            Object.keys(basePricingTiers).forEach(tierKey => {
                const tier = basePricingTiers[tierKey];
                const suggestedPrice = Math.round(basePrice * (1 - tier.discount / 100));
                const rangeText = tier.max === Infinity ? `${tier.min}+` : `${tier.min}-${tier.max}`;
                const discountText = tier.discount > 0 ? ` (-${tier.discount}%)` : '';
                const isInRange = currentQuantity >= tier.min && currentQuantity <= tier.max;
                
                tiersHtml += `
                    <div class="pricing-tier ${isInRange ? 'active-tier' : ''}" style="
                        padding: 15px; 
                        border-radius: 8px; 
                        border: 2px solid ${isInRange ? '#17a2b8' : 'transparent'};
                        background: ${isInRange ? 'rgba(23, 162, 184, 0.1)' : 'rgba(255,255,255,0.5)'};
                        transition: all 0.3s ease;
                        cursor: ${isInRange ? 'default' : 'pointer'};
                    " ${!isInRange ? `onclick="applySuggestedPrice(${suggestedPrice})"` : ''}>
                        <div style="font-weight: bold; color: #495057; margin-bottom: 5px;">
                            ${rangeText} tablettes
                        </div>
                        <div style="font-size: 1.1rem; color: #17a2b8; font-weight: bold;">
                            ${suggestedPrice.toLocaleString()} FCFA/tablette
                        </div>
                        <div style="font-size: 0.85rem; color: #6c757d;">
                            ${tier.name}${discountText}
                        </div>
                        ${isInRange ? '<div style="font-size: 0.8rem; color: #17a2b8; font-weight: bold; margin-top: 5px;">📊 Palier actuel</div>' : ''}
                        ${!isInRange ? '<div style="font-size: 0.75rem; color: #6c757d; margin-top: 5px;">Cliquer pour appliquer</div>' : ''}
                    </div>
                `;
            });
            
            pricingGrid.innerHTML = tiersHtml;
        }

        function applySuggestedPrice(price) {
            document.getElementById('sales-price').value = price;
            calculateTotal();
            showAlert(`Prix suggéré appliqué: ${price.toLocaleString()} FCFA/tablette`, 'info');
        }
        
        function updateSalesCalculations() {
            const quantity = parseInt(document.getElementById('sales-trays').value) || 0;
            const basePrice = parseFloat(document.getElementById('sales-base-price').value) || 2500;
            const bulkInfo = document.getElementById('bulk-info');
            
            if (quantity === 0) {
                bulkInfo.textContent = '';
                document.getElementById('sales-total').value = '';
                updatePricingTiers();
                return;
            }
            
            // Validate quantity
            if (quantity < 0) {
                showAlert('La quantité ne peut pas être négative.', 'warning');
                document.getElementById('sales-trays').value = '';
                return;
            }

            // Find current tier and show suggested pricing info
            const currentTierKey = getCurrentTier(quantity);
            const currentTier = basePricingTiers[currentTierKey];
            const suggestedPrice = Math.round(basePrice * (1 - currentTier.discount / 100));
            
            bulkInfo.innerHTML = `
                📊 Palier ${currentTier.name} (${quantity} tablettes)<br>
                💡 Prix suggéré: ${suggestedPrice.toLocaleString()} FCFA/tablette
                ${currentTier.discount > 0 ? `<br>🎯 Remise suggérée: -${currentTier.discount}%` : ''}
            `;
            
            // Update visual indicators
            updatePricingTiers();
            
            // Calculate total if price is already entered
            calculateTotal();
            
            // Check stock availability
            checkStockAvailability(quantity);
        }
        
        function calculateTotal() {
            const quantity = parseInt(document.getElementById('sales-trays').value) || 0;
            const price = parseFloat(document.getElementById('sales-price').value) || 0;
            const totalField = document.getElementById('sales-total');
            const bulkInfo = document.getElementById('bulk-info');
            
            if (quantity > 0 && price > 0) {
                const total = quantity * price;
                totalField.value = total.toLocaleString();
                
                // Show comparison with suggested price
                const basePrice = parseFloat(document.getElementById('sales-base-price').value) || 2500;
                const currentTierKey = getCurrentTier(quantity);
                const currentTier = basePricingTiers[currentTierKey];
                const suggestedPrice = Math.round(basePrice * (1 - currentTier.discount / 100));
                const difference = price - suggestedPrice;
                
                let comparisonText = '';
                if (Math.abs(difference) > 0) {
                    const diffPercentage = ((difference / suggestedPrice) * 100).toFixed(1);
                    if (difference > 0) {
                        comparisonText = `<br>📈 +${difference.toLocaleString()} FCFA par rapport au prix suggéré (+${diffPercentage}%)`;
                    } else {
                        comparisonText = `<br>📉 ${difference.toLocaleString()} FCFA par rapport au prix suggéré (${diffPercentage}%)`;
                    }
                }
                
                bulkInfo.innerHTML = `
                    📊 Palier ${currentTier.name} (${quantity} tablettes)<br>
                    💡 Prix suggéré: ${suggestedPrice.toLocaleString()} FCFA/tablette<br>
                    💰 Prix appliqué: ${price.toLocaleString()} FCFA/tablette
                    ${comparisonText}
                `;
            } else {
                totalField.value = '';
            }
        }
        
        function getCurrentTier(quantity) {
            for (const [tierKey, tier] of Object.entries(basePricingTiers)) {
                if (quantity >= tier.min && quantity <= tier.max) {
                    return tierKey;
                }
            }
            return 'tier1';
        }
        
        function checkStockAvailability(tablettesRequested) {
            const eggsNeeded = tablettesRequested * 30;
            const availableTablettes = Math.floor(currentEggStock / 30);
            const bulkInfo = document.getElementById('bulk-info');
            
            if (eggsNeeded > currentEggStock) {
                bulkInfo.innerHTML += `<br>⚠️ Stock insuffisant! Disponible: ${availableTablettes} tablettes (${currentEggStock.toLocaleString()} œufs)`;
                bulkInfo.style.color = '#dc3545';
            } else if (eggsNeeded > currentEggStock * 0.8) {
                bulkInfo.innerHTML += `<br>📦 Attention: Stock faible après cette vente`;
                bulkInfo.style.color = '#ffc107';
            } else {
                bulkInfo.style.color = '#17a2b8';
            }
        }
        
        // Enhanced production calculation with validation
        function calculatePonteRate(lotId) {
            const effectif = parseInt(document.getElementById(`${lotId}-effectif`).value) || 0;
            const oeufs = parseInt(document.getElementById(`${lotId}-oeufs`).value) || 0;
            const tauxElement = document.getElementById(`${lotId}-taux`);
            
            // Validation
            if (oeufs < 0) {
                showAlert('Le nombre d\'œufs ne peut pas être négatif.', 'warning');
                document.getElementById(`${lotId}-oeufs`).value = '';
                return;
            }

            if (oeufs > effectif * 1.2) {
                showAlert(`Attention: ${oeufs} œufs pour ${effectif} poules semble élevé (>${(oeufs/effectif*100).toFixed(1)}%). Vérifiez la saisie.`, 'warning');
            }
            
            if (effectif > 0 && oeufs >= 0) {
                const taux = Math.round((oeufs / effectif) * 100 * 10) / 10; // Arrondi à 1 décimale
                tauxElement.textContent = taux;
                
                // Couleur selon la performance avec seuils améliorés
                if (taux >= 85) {
                    tauxElement.style.color = '#28a745'; // Excellent
                } else if (taux >= 75) {
                    tauxElement.style.color = '#20c997'; // Très bon
                } else if (taux >= 65) {
                    tauxElement.style.color = '#ffc107'; // Bon
                } else if (taux >= 50) {
                    tauxElement.style.color = '#fd7e14'; // Moyen
                } else if (taux > 0) {
                    tauxElement.style.color = '#dc3545'; // Faible
                } else {
                    tauxElement.style.color = '#6c757d'; // Pas de production
                }
            } else {
                tauxElement.textContent = '-';
                tauxElement.style.color = '#6c757d';
            }
            
            updateProductionSummary();
        }
        
        function updateEffectif(lotId) {
            const effectifElement = document.getElementById(`${lotId}-effectif`);
            const mortalite = parseInt(document.getElementById(`${lotId}-mortalite`).value) || 0;
            const currentEffectif = parseInt(effectifElement.value) || 0;
            
            if (mortalite < 0) {
                showAlert('La mortalité ne peut pas être négative.', 'warning');
                document.getElementById(`${lotId}-mortalite`).value = '';
                return;
            }

            if (mortalite > currentEffectif) {
                showAlert(`Attention: Mortalité (${mortalite}) supérieure à l'effectif actuel (${currentEffectif}). Vérifiez la saisie.`, 'warning');
                return;
            }
            
            if (mortalite > 0) {
                const newEffectif = Math.max(0, currentEffectif - mortalite);
                effectifElement.value = newEffectif;
                
                // Recalculate egg laying rate with new herd size
                calculatePonteRate(lotId);
                
                showAlert(`Effectif ${lotId.toUpperCase()} mis à jour: ${newEffectif} poules (-${mortalite})`, 'warning');
                logActivity('effectif_update', `${lotId}: ${currentEffectif} -> ${newEffectif} (-${mortalite})`);
            }
        }
        
        function editEffectif(lotId) {
            const effectifElement = document.getElementById(`${lotId}-effectif`);
            const currentValue = effectifElement.value;
            
            effectifElement.readOnly = false;
            effectifElement.style.background = '#fff3cd';
            effectifElement.style.border = '2px solid #ffc107';
            effectifElement.focus();
            effectifElement.select();
            
            effectifElement.onblur = function() {
                effectifElement.readOnly = true;
                effectifElement.style.background = '';
                effectifElement.style.border = '1px solid #ddd';
                
                const newValue = parseInt(effectifElement.value) || 0;
                
                if (newValue < 0) {
                    showAlert('L\'effectif ne peut pas être négatif.', 'warning');
                    effectifElement.value = currentValue;
                    return;
                }

                if (newValue !== parseInt(currentValue)) {
                    const difference = newValue - parseInt(currentValue);
                    const action = difference > 0 ? 'ajouté' : 'retiré';
                    showAlert(`Effectif ${lotId.toUpperCase()} ${action}: ${Math.abs(difference)} poules. Nouveau total: ${newValue}`, 'info');
                    logActivity('manual_effectif_change', `${lotId}: ${currentValue} -> ${newValue} (${difference > 0 ? '+' : ''}${difference})`);
                }
                
                calculatePonteRate(lotId);
            };
            
            effectifElement.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    effectifElement.blur();
                }
                // Only allow numbers
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') {
                    e.preventDefault();
                }
            };
        }
        
        function updateProductionSummary() {
            let totalOeufs = 0;
            let totalCasses = 0;
            let totalMortalite = 0;
            let totalEffectifProducteur = 0;
            let totalOeufsProducteur = 0;
            
            ['lot1', 'lot2'].forEach(lotId => {
                const oeufs = parseInt(document.getElementById(`${lotId}-oeufs`).value) || 0;
                const casses = parseInt(document.getElementById(`${lotId}-casses`).value) || 0;
                const mortalite = parseInt(document.getElementById(`${lotId}-mortalite`).value) || 0;
                const effectif = parseInt(document.getElementById(`${lotId}-effectif`).value) || 0;
                
                totalOeufs += oeufs;
                totalCasses += casses;
                totalMortalite += mortalite;
                
                // Pour le taux moyen, ne compter que les lots en production (avec des œufs)
                if (oeufs > 0) {
                    totalEffectifProducteur += effectif;
                    totalOeufsProducteur += oeufs;
                }
            });
            
            document.getElementById('totalOeufsJour').textContent = totalOeufs.toLocaleString();
            document.getElementById('totalCassesJour').textContent = totalCasses.toLocaleString();
            document.getElementById('totalMortaliteJour').textContent = totalMortalite.toLocaleString();
            
            // Calcul du taux moyen pondéré
            if (totalEffectifProducteur > 0) {
                const tauxMoyen = Math.round((totalOeufsProducteur / totalEffectifProducteur) * 100 * 10) / 10;
                document.getElementById('tauxMoyenJour').textContent = tauxMoyen;
            } else {
                document.getElementById('tauxMoyenJour').textContent = '-';
            }
        }

        function updateFeedInfo() {
            const feedType = document.getElementById('alim-type').value;
            const poidsSacField = document.getElementById('alim-poids-sac');
            const prixSacField = document.getElementById('alim-prix-sac');
            
            // Valeurs par défaut selon le type d'aliment
            const feedDefaults = {
                'ponte': { poids: 50, prix: 26000 },
                'croissance': { poids: 50, prix: 25000 },
                'demarrage': { poids: 25, prix: 15000 },
                'finition': { poids: 50, prix: 24000 }
            };
            
            if (feedDefaults[feedType]) {
                poidsSacField.value = feedDefaults[feedType].poids;
                prixSacField.placeholder = `Ex: ${feedDefaults[feedType].prix.toLocaleString()}`;
            }
            
            calculateFeedTotal();
        }
        
        function calculateFeedTotal() {
            const nombreSacs = parseFloat(document.getElementById('alim-sacs').value) || 0;
            const poidsSac = parseFloat(document.getElementById('alim-poids-sac').value) || 0;
            const prixSac = parseFloat(document.getElementById('alim-prix-sac').value) || 0;
            
            // Validation
            if (nombreSacs < 0 || poidsSac < 0 || prixSac < 0) {
                showAlert('Les valeurs ne peuvent pas être négatives.', 'warning');
                return;
            }

            const quantiteTotale = nombreSacs * poidsSac;
            const coutTotal = nombreSacs * prixSac;
            
            document.getElementById('alim-qte-totale').value = quantiteTotale.toLocaleString();
            document.getElementById('alim-cout-total').value = coutTotal.toLocaleString();
            
            // Afficher l'analyse des coûts si des données sont saisies
            if (nombreSacs > 0 && poidsSac > 0 && prixSac > 0) {
                showFeedAnalysis(quantiteTotale, coutTotal, prixSac, poidsSac);
            } else {
                document.getElementById('feedAnalysis').style.display = 'none';
            }
        }
        
        function showFeedAnalysis(quantiteTotale, coutTotal, prixSac, poidsSac) {
            const feedAnalysis = document.getElementById('feedAnalysis');
            const feedType = document.getElementById('alim-type').value;
            
            // Calcul du coût par kg
            const costPerKg = Math.round(prixSac / poidsSac);
            
            // Estimation de la consommation par poule par jour selon le type
            const dailyConsumption = {
                'ponte': 120,        // grammes/jour pour poules pondeuses
                'croissance': 80,    // grammes/jour pour jeunes poules
                'demarrage': 30,     // grammes/jour pour poussins
                'finition': 100      // grammes/jour pour finition
            };
            
            const dailyConsumptionKg = dailyConsumption[feedType] / 1000;
            const costPerPoulePerDay = Math.round(costPerKg * dailyConsumptionKg);
            
            // Estimation de la durée d'alimentation pour tous les lots
            const totalPoules = 1460; // Total current poultry
            const dailyNeedsKg = totalPoules * dailyConsumptionKg;
            const feedDurationDays = Math.round(quantiteTotale / dailyNeedsKg);
            
            document.getElementById('costPerKg').textContent = costPerKg.toLocaleString();
            document.getElementById('costPerPoule').textContent = costPerPoulePerDay;
            document.getElementById('feedDuration').textContent = feedDurationDays;
            
            feedAnalysis.style.display = 'block';
        }

        function updateEggStock() {
            const availableTablettes = Math.floor(currentEggStock / 30);
            const remainingEggs = currentEggStock % 30;
            const avgPrice = 2400; // Prix moyen pour calculer la valeur
            const stockValue = availableTablettes * avgPrice;
            
            document.getElementById('stockOeufs').textContent = currentEggStock.toLocaleString();
            document.getElementById('stockTablettes').textContent = availableTablettes.toLocaleString();
            document.getElementById('stockRestant').textContent = remainingEggs.toLocaleString();
            document.getElementById('valeurStock').textContent = stockValue.toLocaleString();
            
            // Générer des alertes si nécessaire
            generateStockAlerts(availableTablettes, remainingEggs);
        }
        
        function generateStockAlerts(tablettes, restant) {
            const alertsContainer = document.getElementById('stockAlerts');
            let alerts = '';
            
            if (tablettes < 20) {
                alerts += `
                    <div class="alert alert-warning">
                        <strong>⚠️ Stock Faible:</strong> Seulement ${tablettes} tablettes complètes disponibles. 
                        Planifiez la production ou limitez les ventes.
                    </div>
                `;
            }
            
            if (tablettes < 10) {
                alerts += `
                    <div class="alert alert-danger">
                        <strong>🚨 Stock Critique:</strong> Stock très faible (${tablettes} tablettes). 
                        Action immédiate requise!
                    </div>
                `;
            }
            
            if (restant > 20) {
                alerts += `
                    <div class="alert alert-info">
                        <strong>📦 Optimisation:</strong> ${restant} œufs en attente d'emballage. 
                        ${30 - restant} œufs de plus pour une tablette complète.
                    </div>
                `;
            }
            
            if (tablettes > 100) {
                alerts += `
                    <div class="alert alert-success">
                        <strong>✅ Stock Excellent:</strong> ${tablettes} tablettes disponibles. 
                        Bon niveau de stock pour les ventes.
                    </div>
                `;
            }
            
            alertsContainer.innerHTML = alerts;
        }
        
        function adjustStock() {
            const adjustment = parseInt(document.getElementById('stock-adjustment').value) || 0;
            const reason = document.getElementById('stock-reason').value;
            
            if (adjustment === 0) {
                showAlert('Veuillez entrer un ajustement valide.', 'warning');
                return;
            }
            
            const newStock = currentEggStock + adjustment;
            
            if (newStock < 0) {
                showAlert('Ajustement impossible: le stock ne peut pas être négatif.', 'danger');
                return;
            }
            
            currentEggStock = newStock;
            updateEggStock();
            
            // Sauvegarder dans Google Sheets
            if (isConnected) {
                saveStockAdjustment(adjustment, reason);
            }
            
            const actionText = adjustment > 0 ? 'ajouté' : 'retiré';
            showAlert(`Stock mis à jour: ${Math.abs(adjustment)} œufs ${actionText}. Nouveau stock: ${currentEggStock.toLocaleString()} œufs`, 'success');
            logActivity('stock_adjustment', `${adjustment} œufs (${reason}). Nouveau stock: ${currentEggStock}`);
            
            // Réinitialiser le formulaire
            document.getElementById('stock-adjustment').value = '';
        }
        
        async function saveStockAdjustment(adjustment, reason) {
            try {
                const adjustmentData = {
                    date: new Date().toISOString().split('T')[0],
                    adjustment: adjustment,
                    reason: reason,
                    newStock: currentEggStock,
                    tablettesAvailable: Math.floor(currentEggStock / 30),
                    user: currentUser.username
                };
                
                // Simuler la sauvegarde
                console.log('Sauvegarde ajustement stock:', adjustmentData);
                logActivity('stock_saved', `Ajustement sauvegardé: ${adjustment} œufs`);
                
            } catch (error) {
                console.error('Erreur sauvegarde stock:', error);
                logActivity('stock_save_error', `Erreur sauvegarde: ${error.message}`);
            }
        }

        // Enhanced daily log saving with comprehensive validation
        async function saveDailyLog() {
            if (!isConnected) {
                showAlert('Veuillez d\'abord vous connecter à Google Sheets.', 'warning');
                return;
            }

            const date = document.getElementById('daily-log-date').value;
            
            if (!date) {
                showAlert('Veuillez remplir au minimum la date.', 'warning');
                document.getElementById('daily-log-date').focus();
                return;
            }

            // Validate date is not in the future
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // End of today
            
            if (selectedDate > today) {
                showAlert('La date ne peut pas être dans le futur.', 'warning');
                document.getElementById('daily-log-date').focus();
                return;
            }

            // Données de production par lot avec validation
            const productionData = {
                lot1: {
                    effectif: parseInt(document.getElementById('lot1-effectif').value) || 0,
                    oeufs: parseInt(document.getElementById('lot1-oeufs').value) || 0,
                    casses: parseInt(document.getElementById('lot1-casses').value) || 0,
                    mortalite: parseInt(document.getElementById('lot1-mortalite').value) || 0,
                    observations: document.getElementById('lot1-observations').value.trim(),
                    taux: document.getElementById('lot1-taux').textContent
                },
                lot2: {
                    effectif: parseInt(document.getElementById('lot2-effectif').value) || 0,
                    oeufs: parseInt(document.getElementById('lot2-oeufs').value) || 0,
                    casses: parseInt(document.getElementById('lot2-casses').value) || 0,
                    mortalite: parseInt(document.getElementById('lot2-mortalite').value) || 0,
                    observations: document.getElementById('lot2-observations').value.trim(),
                    taux: document.getElementById('lot2-taux').textContent
                }
            };

            // Validation des données de production
            ['lot1', 'lot2'].forEach(lotId => {
                const data = productionData[lotId];
                if (data.oeufs > data.effectif * 1.5) {
                    showAlert(`Attention: ${data.oeufs} œufs pour ${data.effectif} poules dans ${lotId.toUpperCase()} semble très élevé. Vérifiez la saisie.`, 'warning');
                }
                if (data.casses > data.oeufs) {
                    showAlert(`Erreur: Œufs cassés (${data.casses}) supérieurs aux œufs collectés (${data.oeufs}) pour ${lotId.toUpperCase()}.`, 'danger');
                    return;
                }
            });
            
            // Données d'alimentation avec validation
            const alimentSacs = parseInt(document.getElementById('alim-sacs').value) || 0;
            const alimentPoidsSac = parseFloat(document.getElementById('alim-poids-sac').value) || 0;
            const alimentPrixSac = parseFloat(document.getElementById('alim-prix-sac').value) || 0;
            const alimentCoutTotal = parseFloat(document.getElementById('alim-cout-total').value.replace(/,/g, '')) || 0;

            // Validation alimentation
            if (alimentSacs > 0 && (alimentPoidsSac <= 0 || alimentPrixSac <= 0)) {
                showAlert('Si vous saisissez des sacs d\'aliment, veuillez remplir le poids et le prix.', 'warning');
                return;
            }

            const salesTrays = parseInt(document.getElementById('sales-trays').value) || 0;
            const salesPrice = parseFloat(document.getElementById('sales-price').value) || 0;
            const salesClient = document.getElementById('sales-client').value.trim();

            // Validation ventes
            if (salesTrays > 0 && salesPrice <= 0) {
                showAlert('Si vous saisissez des tablettes vendues, veuillez indiquer le prix de vente.', 'warning');
                return;
            }

            try {
                showAlert('Sauvegarde en cours...', 'info');
                logActivity('daily_log_save_start', `Sauvegarde du ${date}`);
                
                // Calculer les totaux de production
                const totalOeufs = productionData.lot1.oeufs + productionData.lot2.oeufs;
                const totalCasses = productionData.lot1.casses + productionData.lot2.casses;
                const totalMortalite = productionData.lot1.mortalite + productionData.lot2.mortalite;
                
                // Gestion du stock avec la production et les ventes
                let stockAdjustment = 0;
                
                // Ajouter la production au stock
                if (totalOeufs > 0) {
                    stockAdjustment += totalOeufs;
                    showAlert(`Production ajoutée: +${totalOeufs} œufs (Lot1: ${productionData.lot1.oeufs}, Lot2: ${productionData.lot2.oeufs})`, 'info');
                }
                
                // Retirer les œufs cassés du stock
                if (totalCasses > 0) {
                    stockAdjustment -= totalCasses;
                    showAlert(`Œufs cassés retirés: -${totalCasses} œufs`, 'warning');
                }
                
                // Retirer les ventes du stock
                if (salesTrays > 0) {
                    const eggsNeeded = salesTrays * 30;
                    
                    if (eggsNeeded > currentEggStock + stockAdjustment) {
                        showAlert('Vente impossible: stock insuffisant même avec la production du jour.', 'danger');
                        return;
                    }
                    
                    stockAdjustment -= eggsNeeded;
                    const revenue = salesTrays * salesPrice;
                    showAlert(`Vente enregistrée: ${salesTrays} tablettes = ${revenue.toLocaleString()} FCFA`, 'success');
                }
                
                // Validation des données d'alimentation
                if (alimentSacs > 0 && alimentCoutTotal > 0) {
                    showAlert(`Alimentation enregistrée: ${alimentSacs} sacs = ${alimentCoutTotal.toLocaleString()} FCFA`, 'info');
                }
                
                // Mettre à jour le stock
                currentEggStock += stockAdjustment;
                updateEggStock();
                
                // Données complètes pour Google Sheets
                const completeData = {
                    date,
                    production: productionData,
                    alimentation: {
                        type: document.getElementById('alim-type').value,
                        nombreSacs: alimentSacs,
                        poidsSac: alimentPoidsSac,
                        prixSac: alimentPrixSac,
                        quantiteTotale: parseFloat(document.getElementById('alim-qte-totale').value.replace(/,/g, '')) || 0,
                        coutTotal: alimentCoutTotal,
                        lotsConcernes: Array.from(document.getElementById('alim-lot').selectedOptions).map(option => option.value),
                        fournisseur: document.getElementById('alim-fournisseur').value.trim(),
                        notes: document.getElementById('alim-notes').value.trim()
                    },
                    ventes: {
                        tablettes: salesTrays,
                        prixUnitaire: salesPrice,
                        client: salesClient,
                        total: salesTrays * salesPrice
                    },
                    sante: {
                        mortaliteGenerale: parseInt(document.getElementById('sante-mortalite').value) || 0,
                        observations: document.getElementById('sante-notes').value.trim()
                    },
                    totaux: {
                        oeufs: totalOeufs,
                        casses: totalCasses,
                        mortalite: totalMortalite
                    },
                    utilisateur: currentUser.username,
                    timestamp: new Date().toISOString()
                };
                
                // Simuler la sauvegarde avec délai réaliste
                setTimeout(() => {
                    showAlert('Données sauvegardées avec succès dans Google Sheets !', 'success');
                    logActivity('daily_log_saved', `Journal du ${date} sauvegardé avec succès`);
                    clearDailyForm();
                    loadDashboardData(); // Actualiser le tableau de bord
                    
                    // Show summary of what was saved
                    const summaryParts = [];
                    if (totalOeufs > 0) summaryParts.push(`${totalOeufs} œufs produits`);
                    if (salesTrays > 0) summaryParts.push(`${salesTrays} tablettes vendues`);
                    if (alimentCoutTotal > 0) summaryParts.push(`${alimentCoutTotal.toLocaleString()} FCFA d'aliment`);
                    
                    if (summaryParts.length > 0) {
                        showAlert(`Résumé sauvegardé: ${summaryParts.join(', ')}.`, 'info');
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Erreur de sauvegarde:', error);
                showAlert('Erreur lors de la sauvegarde. Vérifiez votre connexion.', 'danger');
                logActivity('daily_log_save_error', `Erreur sauvegarde: ${error.message}`);
            }
        }

        async function saveInvestment() {
            if (!isConnected) {
                showAlert('Veuillez d\'abord vous connecter à Google Sheets.', 'warning');
                return;
            }

            const description = document.getElementById('inv-description').value.trim();
            const montant = parseFloat(document.getElementById('inv-montant').value) || 0;
            const categorie = document.getElementById('inv-categorie').value;
            const date = document.getElementById('inv-date').value;

            if (!description || montant <= 0 || !date) {
                showAlert('Veuillez remplir tous les champs obligatoires avec des valeurs valides.', 'warning');
                return;
            }

            // Validate date
            const selectedDate = new Date(date);
            const today = new Date();
            if (selectedDate > today) {
                showAlert('La date d\'investissement ne peut pas être dans le futur.', 'warning');
                return;
            }

            try {
                showAlert('Ajout de l\'investissement...', 'info');
                logActivity('investment_add_start', `Nouvel investissement: ${description} - ${montant} FCFA`);
                
                const investmentData = {
                    date,
                    description,
                    categorie,
                    montant,
                    utilisateur: currentUser.username,
                    timestamp: new Date().toISOString()
                };
                
                setTimeout(() => {
                    showAlert(`Investissement ajouté avec succès ! ${description} - ${montant.toLocaleString()} FCFA`, 'success');
                    logActivity('investment_added', `${description} - ${montant} FCFA`);
                    clearInvestmentForm();
                    loadInvestments();
                }, 1500);
                
            } catch (error) {
                console.error('Erreur d\'ajout:', error);
                showAlert('Erreur lors de l\'ajout de l\'investissement.', 'danger');
                logActivity('investment_add_error', `Erreur ajout: ${error.message}`);
            }
        }

        // Enhanced data loading functions with better error handling
        async function loadDashboardData() {
            if (!isConnected) return;

            try {
                // Show loading state
                const loadingElements = ['totalPoules', 'prodJournaliere', 'revenusJour', 'efficaciteAlimentaire', 'coutJour'];
                loadingElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = '⏳';
                });

                // Simulate realistic data loading
                setTimeout(() => {
                    // Update statistics with enhanced data
                    document.getElementById('headerTotalPoules').textContent = '1,460';
                    document.getElementById('headerProduction').textContent = '10,800';
                    document.getElementById('headerROI').textContent = '-43%';
                    document.getElementById('headerProfitability').textContent = '98.6';
                    
                    document.getElementById('totalPoules').textContent = '1,460';
                    document.getElementById('prodJournaliere').textContent = '360';
                    document.getElementById('revenusJour').textContent = '15,000';
                    document.getElementById('efficaciteAlimentaire').textContent = '2.8';
                    document.getElementById('coutJour').textContent = '35,500';
                    
                    // Update lot summary
                    updateSummaryGrid();
                    
                    logActivity('dashboard_loaded', 'Tableau de bord actualisé');
                }, 1500);
                
            } catch (error) {
                console.error('Erreur de chargement dashboard:', error);
                showAlert('Erreur lors du chargement du tableau de bord.', 'danger');
                logActivity('dashboard_load_error', `Erreur: ${error.message}`);
            }
        }

        async function loadInvestments() {
            if (!isConnected) return;

            const tbody = document.querySelector('#investmentsTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;"><div class="loading-spinner"></div> Chargement...</td></tr>';

            try {
                setTimeout(() => {
                    const sampleData = [
                        ['Construction du poulailler principal', 'Bâtiment', '2,500,000', '2025-01-10'],
                        ['Achat de 1000 poussins (Lot 1)', 'Achat de Sujets', '750,000', '2025-03-05'],
                        ['Mangeoires et abreuvoirs', 'Matériel', '450,000', '2025-02-15'],
                        ['Système d\'éclairage LED', 'Matériel', '125,000', '2025-01-20'],
                        ['Vaccination initiale', 'Frais Vétérinaires initiaux', '85,000', '2025-03-10']
                    ];
                    
                    tbody.innerHTML = '';
                    sampleData.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        tr.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s both`;
                        tr.innerHTML = `
                            <td>${row[0]}</td>
                            <td><span class="status-badge status-active">${row[1]}</span></td>
                            <td style="font-weight: bold; color: #dc3545;">${row[2]}</td>
                            <td>${new Date(row[3]).toLocaleDateString('fr-FR')}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editRow(this)" title="Éditer">✏️</button>
                                <button class="btn btn-danger" onclick="deleteRow(this)" title="Supprimer">🗑️</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    updateInvestmentSummary();
                    logActivity('investments_loaded', `${sampleData.length} investissements chargés`);
                }, 2000);
                
            } catch (error) {
                console.error('Erreur de chargement investissements:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">❌ Erreur de chargement</td></tr>';
                logActivity('investments_load_error', `Erreur: ${error.message}`);
            }
        }

        async function loadInventory() {
            if (!isConnected) return;

            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading-spinner"></div> Chargement...</td></tr>';

            try {
                setTimeout(() => {
                    const sampleData = [
                        ['Aliment Ponte', 'Alimentation', '750', 'kg', '1000', 'Bas'],
                        ['Aliment Croissance', 'Alimentation', '1200', 'kg', '800', 'OK'],
                        ['Désinfectant', 'Santé', '5', 'L', '10', 'Critique'],
                        ['Vitamines', 'Santé', '15', 'kg', '5', 'OK'],
                        ['Mangeoires automatiques', 'Matériel', '48', 'unités', '50', 'Critique'],
                        ['Abreuvoirs', 'Matériel', '125', 'unités', '100', 'OK']
                    ];
                    
                    tbody.innerHTML = '';
                    sampleData.forEach((row, index) => {
                        const statusClass = row[5] === 'OK' ? 'status-active' : 
                                          row[5] === 'Bas' ? 'status-warning' : 'status-inactive';
                        
                        const tr = document.createElement('tr');
                        tr.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s both`;
                        tr.innerHTML = `
                            <td style="font-weight: 600;">${row[0]}</td>
                            <td>${row[1]}</td>
                            <td style="text-align: center; font-weight: bold;">${row[2]}</td>
                            <td style="text-align: center;">${row[3]}</td>
                            <td style="text-align: center;">${row[4]}</td>
                            <td><span class="status-badge ${statusClass}">${row[5]}</span></td>
                            <td>
                                <button class="btn btn-secondary" onclick="editRow(this)" title="Éditer">✏️</button>
                                <button class="btn btn-danger" onclick="deleteRow(this)" title="Supprimer">🗑️</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    logActivity('inventory_loaded', `${sampleData.length} articles d'inventaire chargés`);
                }, 2000);
                
            } catch (error) {
                console.error('Erreur de chargement inventaire:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">❌ Erreur de chargement</td></tr>';
                logActivity('inventory_load_error', `Erreur: ${error.message}`);
            }
        }

        async function loadSalesHistory() {
            if (!isConnected) return;

            const tbody = document.querySelector('#salesLogTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading-spinner"></div> Chargement...</td></tr>';

            try {
                setTimeout(() => {
                    const sampleData = [
                        ['2025-06-14', 'Boutique du coin', '6', '180', '2,500', '15,000'],
                        ['2025-06-13', 'Marché local', '10', '300', '2,400', '24,000'],
                        ['2025-06-12', 'Restaurant ABC', '8', '240', '2,600', '20,800'],
                        ['2025-06-11', 'Supermarché XYZ', '15', '450', '2,300', '34,500'],
                        ['2025-06-10', 'Hôtel Central', '12', '360', '2,550', '30,600']
                    ];
                    
                    tbody.innerHTML = '';
                    sampleData.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        tr.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s both`;
                        tr.innerHTML = `
                            <td>${new Date(row[0]).toLocaleDateString('fr-FR')}</td>
                            <td style="font-weight: 600;">${row[1]}</td>
                            <td style="text-align: center;">${row[2]}</td>
                            <td style="text-align: center;">${row[3]}</td>
                            <td style="text-align: right; font-weight: bold;">${row[4]}</td>
                            <td style="text-align: right; font-weight: bold; color: #28a745;">${row[5]}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editRow(this)" title="Éditer">✏️</button>
                                <button class="btn btn-danger" onclick="deleteRow(this)" title="Supprimer">🗑️</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    logActivity('sales_history_loaded', `${sampleData.length} ventes chargées`);
                }, 2000);
                
            } catch (error) {
                console.error('Erreur de chargement historique ventes:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">❌ Erreur de chargement</td></tr>';
                logActivity('sales_history_load_error', `Erreur: ${error.message}`);
            }
        }

        async function loadProductionHistory() {
            if (!isConnected) return;

            const tbody = document.querySelector('#productionLogTable tbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;"><div class="loading-spinner"></div> Chargement...</td></tr>';

            try {
                setTimeout(() => {
                    const sampleData = [
                        ['2025-06-14', 'Lot 2', '360', '72.0%', '5'],
                        ['2025-06-13', 'Lot 2', '355', '71.0%', '3'],
                        ['2025-06-12', 'Lot 2', '358', '71.6%', '2'],
                        ['2025-06-11', 'Lot 2', '345', '69.0%', '4'],
                        ['2025-06-10', 'Lot 2', '362', '72.4%', '1']
                    ];
                    
                    tbody.innerHTML = '';
                    sampleData.forEach((row, index) => {
                        const tauxValue = parseFloat(row[3]);
                        const tauxColor = tauxValue >= 75 ? '#28a745' : tauxValue >= 65 ? '#ffc107' : '#dc3545';
                        
                        const tr = document.createElement('tr');
                        tr.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s both`;
                        tr.innerHTML = `
                            <td>${new Date(row[0]).toLocaleDateString('fr-FR')}</td>
                            <td><span class="status-badge status-active">${row[1]}</span></td>
                            <td style="text-align: center; font-weight: bold;">${row[2]}</td>
                            <td style="text-align: center; font-weight: bold; color: ${tauxColor};">${row[3]}</td>
                            <td style="text-align: center; color: ${row[4] > 3 ? '#dc3545' : '#6c757d'};">${row[4]}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editRow(this)" title="Éditer">✏️</button>
                                <button class="btn btn-danger" onclick="deleteRow(this)" title="Supprimer">🗑️</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    logActivity('production_history_loaded', `${sampleData.length} entrées de production chargées`);
                }, 2000);
                
            } catch (error) {
                console.error('Erreur de chargement historique production:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">❌ Erreur de chargement</td></tr>';
                logActivity('production_history_load_error', `Erreur: ${error.message}`);
            }
        }

        async function loadHealthHistory() {
            if (!isConnected) return;

            const tbody = document.querySelector('#healthLogTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;"><div class="loading-spinner"></div> Chargement...</td></tr>';

            try {
                setTimeout(() => {
                    const sampleData = [
                        ['2025-06-10', 'Lot 2', '0', 'Contrôle de routine - Bonne santé générale'],
                        ['2025-06-05', 'Lot 1', '2', 'Vaccination standard pour jeunes poules'],
                        ['2025-05-30', 'Lot 2', '1', 'Traitement préventif anti-stress'],
                        ['2025-05-25', 'Tous', '0', 'Désinfection complète du poulailler'],
                        ['2025-05-20', 'Lot 1', '3', 'Adaptation suite à l\'arrivée - mortalité normale']
                    ];
                    
                    tbody.innerHTML = '';
                    sampleData.forEach((row, index) => {
                        const mortaliteValue = parseInt(row[2]);
                        const mortaliteColor = mortaliteValue === 0 ? '#28a745' : mortaliteValue <= 2 ? '#ffc107' : '#dc3545';
                        
                        const tr = document.createElement('tr');
                        tr.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s both`;
                        tr.innerHTML = `
                            <td>${new Date(row[0]).toLocaleDateString('fr-FR')}</td>
                            <td><span class="status-badge ${row[1] === 'Tous' ? 'status-info' : 'status-active'}">${row[1]}</span></td>
                            <td style="text-align: center; font-weight: bold; color: ${mortaliteColor};">${row[2]}</td>
                            <td style="max-width: 300px;">${row[3]}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editRow(this)" title="Éditer">✏️</button>
                                <button class="btn btn-danger" onclick="deleteRow(this)" title="Supprimer">🗑️</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    logActivity('health_history_loaded', `${sampleData.length} entrées sanitaires chargées`);
                }, 2000);
                
            } catch (error) {
                console.error('Erreur de chargement historique santé:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">❌ Erreur de chargement</td></tr>';
                logActivity('health_history_load_error', `Erreur: ${error.message}`);
            }
        }

        async function loadAnalysisData() {
            if (!isConnected) return;

            try {
                // Show loading state
                const analysisElements = ['coutParOeuf', 'prixVenteOeuf', 'margeOeuf', 'pointMort'];
                analysisElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = '⏳';
                });

                setTimeout(() => {
                    document.getElementById('coutParOeuf').textContent = '98.6';
                    document.getElementById('prixVenteOeuf').textContent = '83.3';
                    document.getElementById('margeOeuf').textContent = '-15.3';
                    document.getElementById('pointMort').textContent = '426';
                    
                    logActivity('analysis_loaded', 'Données d\'analyse chargées');
                }, 1500);
                
            } catch (error) {
                console.error('Erreur de chargement analyse:', error);
                logActivity('analysis_load_error', `Erreur: ${error.message}`);
            }
        }

        // Enhanced utility functions
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            
            switch(status) {
                case 'connecting':
                    statusElement.className = 'connection-status disconnected';
                    statusElement.innerHTML = '<span class="loading-spinner"></span> Connexion en cours...';
                    break;
                case 'connected':
                    statusElement.className = 'connection-status connected';
                    statusElement.innerHTML = '✅ Connecté à Google Sheets';
                    break;
                case 'disconnected':
                    statusElement.className = 'connection-status disconnected';
                    statusElement.innerHTML = '❌ Non connecté';
                    break;
            }
        }

        function hideSetupSection() {
            const setupSection = document.getElementById('setupSection');
            setupSection.style.transition = 'all 0.5s ease-out';
            setupSection.style.transform = 'translateY(-20px)';
            setupSection.style.opacity = '0';
            
            setTimeout(() => {
                setupSection.style.display = 'none';
            }, 500);
        }

        function updateSummaryGrid() {
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="label">Lot 1 (9 semaines)</div>
                    <div class="value">960</div>
                    <div class="label">Démarré le 13/05/2025</div>
                    <span class="status-badge status-warning">En croissance</span>
                </div>
                <div class="summary-item">
                    <div class="label">Lot 2 (20 semaines)</div>
                    <div class="value">500</div>
                    <div class="label">En production</div>
                    <span class="status-badge status-active">Productif</span>
                </div>
                <div class="summary-item">
                    <div class="label">Production Mensuelle</div>
                    <div class="value">10,800</div>
                    <div class="label">œufs estimés</div>
                </div>
                <div class="summary-item">
                    <div class="label">Coût Mensuel</div>
                    <div class="value">1,065,000</div>
                    <div class="label">FCFA</div>
                </div>
                <div class="summary-item">
                    <div class="label">Marge Brute</div>
                    <div class="value">-486,000</div>
                    <div class="label">FCFA/mois</div>
                </div>
                <div class="summary-item">
                    <div class="label">Âge Moyen</div>
                    <div class="value">12.5</div>
                    <div class="label">semaines</div>
                </div>
            `;
        }

        function updateInvestmentSummary() {
            document.getElementById('investissementTotal').textContent = '4,150,000';
            document.getElementById('coutParPoule').textContent = '2,842';
            document.getElementById('amortissement').textContent = '138,333';
            document.getElementById('valeurResiduelle').textContent = '830,000';
        }

        function clearInvestmentForm() {
            document.getElementById('inv-description').value = '';
            document.getElementById('inv-montant').value = '';
            document.getElementById('inv-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('inv-description').focus();
        }

        // Enhanced alert system with auto-dismiss and better styling
        function showAlert(message, type) {
            // Remove existing alerts of the same type
            const existingAlerts = document.querySelectorAll(`.alert-${type}`);
            existingAlerts.forEach(alert => {
                if (alert.textContent.includes(message.substring(0, 20))) {
                    alert.remove();
                }
            });

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '10001';
            alertDiv.style.maxWidth = '400px';
            alertDiv.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
            alertDiv.style.transform = 'translateX(100%)';
            alertDiv.style.transition = 'transform 0.3s ease-out';
            
            const icon = {
                'success': '✅',
                'warning': '⚠️',
                'danger': '❌',
                'info': 'ℹ️'
            }[type] || 'ℹ️';
            
            alertDiv.innerHTML = `
                <strong>${icon}</strong>
                ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.7;">&times;</button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Animate in
            setTimeout(() => {
                alertDiv.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto-dismiss after delay (longer for errors)
            const dismissTime = type === 'danger' ? 8000 : type === 'warning' ? 6000 : 4000;
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.style.transform = 'translateX(100%)';
                    setTimeout(() => alertDiv.remove(), 300);
                }
            }, dismissTime);
        }

        // Enhanced functions for editing and deleting with confirmation
        function deleteRow(button) {
            const row = button.closest('tr');
            const table = button.closest('table');
            const tableName = table.id.replace('Table', '');
            
            const confirmMessage = `Êtes-vous sûr de vouloir supprimer cette entrée de ${tableName} ? Cette action sera également effectuée dans Google Sheets et ne peut pas être annulée.`;
            
            if (confirm(confirmMessage)) {
                // Animate row removal
                row.style.transition = 'all 0.3s ease-out';
                row.style.transform = 'translateX(-100%)';
                row.style.opacity = '0';
                
                setTimeout(() => {
                    row.remove();
                    showAlert('Entrée supprimée avec succès !', 'success');
                    logActivity('row_deleted', `Suppression dans ${tableName}`);
                }, 300);
            }
        }

        function editRow(button) {
            const row = button.closest('tr');
            const table = button.closest('table');
            const tableName = table.id.replace('Table', '');
            
            showAlert(`Fonction d'édition en cours de développement pour ${tableName}. Vous pouvez modifier directement dans Google Sheets.`, 'info');
            logActivity('edit_attempted', `Tentative d'édition dans ${tableName}`);
        }

        // Enhanced report generation functions
        function generateProductionReport() {
            if (!isConnected) {
                showAlert('Veuillez d\'abord vous connecter à Google Sheets.', 'warning');
                return;
            }
            
            
            setTimeout(() => {
                showAlert('Rapport de production généré ! Consultez votre Google Sheets pour le voir.', 'success');
                logActivity('report_generated', 'Rapport de production généré avec succès');
                
                const reportUrl = `https://docs.google.com/spreadsheets/d/${currentSheetId}/edit`;
                window.open(reportUrl, '_blank');
            }, 3000);
        }

        function generateFinancialReport() {
            if (!isConnected) {
                showAlert('Veuillez d\'abord vous connecter à Google Sheets.', 'warning');
                return;
            }
            
            showAlert('Génération du rapport financier en cours...', 'info');
            logActivity('report_generation_start', 'Rapport financier');
            
            setTimeout(() => {
                showAlert('Rapport financier généré ! Consultez votre Google Sheets pour le voir.', 'success');
                logActivity('report_generated', 'Rapport financier généré avec succès');
                
                const reportUrl = `https://docs.google.com/spreadsheets/d/${currentSheetId}/edit`;
                window.open(reportUrl, '_blank');
            }, 3000);
        }

        function generateInventoryReport() {
            if (!isConnected) {
                showAlert('Veuillez d\'abord vous connecter à Google Sheets.', 'warning');
                return;
            }
            
            showAlert('Génération du rapport d\'inventaire en cours...', 'info');
            logActivity('report_generation_start', 'Rapport d\'inventaire');
            
            setTimeout(() => {
                showAlert('Rapport d\'inventaire généré ! Consultez votre Google Sheets pour le voir.', 'success');
                logActivity('report_generated', 'Rapport d\'inventaire généré avec succès');
                
                const reportUrl = `https://docs.google.com/spreadsheets/d/${currentSheetId}/edit`;
                window.open(reportUrl, '_blank');
            }, 3000);
        }

        function exportAllData() {
            if (!isConnected) {
                showAlert('Veuillez d\'abord vous connecter à Google Sheets.', 'warning');
                return;
            }
            
            showAlert('Export de toutes les données en cours...', 'info');
            logActivity('data_export_start', 'Export de toutes les données');
            
            setTimeout(() => {
                showAlert('Export terminé ! Vous pouvez télécharger les données depuis Google Sheets (Fichier > Télécharger > CSV).', 'success');
                logActivity('data_exported', 'Export de données terminé avec succès');
                
                const exportUrl = `https://docs.google.com/spreadsheets/d/${currentSheetId}/edit`;
                window.open(exportUrl, '_blank');
            }, 3000);
        }

        function showInventoryModal() {
            showAlert('Fonction d\'ajout d\'article en cours de développement. Vous pouvez ajouter directement dans Google Sheets.', 'info');
            logActivity('inventory_modal_attempted', 'Tentative d\'ouverture modal inventaire');
        }

        // Enhanced help function with comprehensive guide
        function showHelp() {
            const helpModal = document.createElement('div');
            helpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10002;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.3s ease-out;
            `;
            
            helpModal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 40px;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                    animation: slideIn 0.4s ease-out;
                ">
                    <button onclick="this.closest('div').parentElement.remove()" style="
                        position: absolute;
                        top: 15px;
                        right: 20px;
                        background: none;
                        border: none;
                        font-size: 1.5rem;
                        cursor: pointer;
                        color: #6c757d;
                    ">&times;</button>
                    
                    <h2 style="color: #343a40; margin-bottom: 20px;">🔗 Guide Complet Google Sheets Integration</h2>
                    
                    <div style="line-height: 1.6; color: #495057;">
                        <h3 style="color: #17a2b8; margin-top: 25px;">1. Configuration Initiale</h3>
                        <ul style="margin-left: 20px;">
                            <li>Créez un nouveau Google Sheets</li>
                            <li>Partagez-le avec "Modifier pour tous ceux qui ont le lien"</li>
                            <li>Copiez l'ID depuis l'URL (entre /d/ et /edit)</li>
                            <li>Collez l'ID dans le champ et connectez-vous</li>
                        </ul>
                        
                        <h3 style="color: #17a2b8; margin-top: 25px;">2. Structure Recommandée</h3>
                        <p>Le système fonctionne mieux avec ces onglets :</p>
                        <ul style="margin-left: 20px;">
                            <li><strong>Production</strong> - Données quotidiennes de ponte</li>
                            <li><strong>Ventes</strong> - Historique des ventes</li>
                            <li><strong>Investissements</strong> - Équipements et coûts</li>
                            <li><strong>Inventaire</strong> - Stocks et fournitures</li>
                            <li><strong>Sante</strong> - Suivi vétérinaire</li>
                        </ul>
                        
                        <h3 style="color: #17a2b8; margin-top: 25px;">3. Fonctionnalités Avancées</h3>
                        <ul style="margin-left: 20px;">
                            <li><strong>Saisie Quotidienne</strong> - Enregistrement production/ventes/alimentation</li>
                            <li><strong>Calculs Automatiques</strong> - Taux de ponte, coûts, marges</li>
                            <li><strong>Alertes Stock</strong> - Notifications automatiques</li>
                            <li><strong>Analyses Financières</strong> - ROI, point mort, rentabilité</li>
                            <li><strong>Rapports</strong> - Génération automatique de rapports</li>
                        </ul>
                        
                        <h3 style="color: #17a2b8; margin-top: 25px;">4. Sécurité & Authentification</h3>
                        <ul style="margin-left: 20px;">
                            <li>Système d'authentification sécurisé</li>
                            <li>Sessions de 8 heures avec renouvellement automatique</li>
                            <li>Journalisation des activités</li>
                            <li>Gestion des autorisations par utilisateur</li>
                        </ul>
                        
                        <h3 style="color: #17a2b8; margin-top: 25px;">5. Conseils d'Utilisation</h3>
                        <ul style="margin-left: 20px;">
                            <li>Saisissez les données quotidiennement pour plus de précision</li>
                            <li>Vérifiez les alertes de stock régulièrement</li>
                            <li>Utilisez les analyses pour optimiser vos performances</li>
                            <li>Sauvegardez régulièrement vos données Google Sheets</li>
                        </ul>
                        
                        <div style="
                            background: rgba(23, 162, 184, 0.1);
                            padding: 15px;
                            border-radius: 10px;
                            margin-top: 25px;
                            border-left: 4px solid #17a2b8;
                        ">
                            <strong>💡 Astuce :</strong> Pour une utilisation optimale, consultez d'abord le tableau de bord pour avoir une vue d'ensemble, puis utilisez la saisie quotidienne pour enregistrer vos données.
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpModal);
            logActivity('help_viewed', 'Guide d\'aide consulté');
        }

        // Auto-refresh and real-time simulation
        setInterval(() => {
            if (isConnected) {
                // Subtle refresh of key data every 5 minutes
                loadDashboardData();
            }
        }, 300000); // 5 minutes

        // Simulate real-time updates
        function simulateRealTimeUpdates() {
            if (!isConnected) return;
            
            setInterval(() => {
                const randomUpdate = Math.random();
                if (randomUpdate > 0.98) { // 2% chance of update
                    showAlert('📊 Nouvelles données détectées dans Google Sheets !', 'info');
                    loadDashboardData();
                    logActivity('realtime_update', 'Mise à jour automatique détectée');
                }
            }, 30000); // Check every 30 seconds
        }

        // Start real-time simulation after initial load
        setTimeout(simulateRealTimeUpdates, 15000);

        // Keyboard shortcuts for power users
        document.addEventListener('keydown', (e) => {
            if (!currentUser) return;
            
            // Ctrl/Cmd + numbers for tab switching
            if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '7') {
                e.preventDefault();
                const tabIndex = parseInt(e.key) - 1;
                if (tabIndex < tabs.length) {
                    switchTab(tabIndex);
                }
            }
            
            // Ctrl/Cmd + S for saving (daily log)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (tabs[0].classList.contains('active')) {
                    saveDailyLog();
                }
            }
            
            // Ctrl/Cmd + R for refresh current tab data
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                const activeTabIndex = Array.from(tabs).findIndex(tab => tab.classList.contains('active'));
                loadTabData(activeTabIndex);
            }
        });

        // Enhanced accessibility features
        function enhanceAccessibility() {
            // Add skip navigation link
            const skipLink = document.createElement('a');
            skipLink.href = '#main-content';
            skipLink.textContent = 'Aller au contenu principal';
            skipLink.style.cssText = `
                position: absolute;
                top: -40px;
                left: 6px;
                background: #000;
                color: #fff;
                padding: 8px;
                text-decoration: none;
                border-radius: 4px;
                z-index: 10000;
            `;
            skipLink.addEventListener('focus', () => {
                skipLink.style.top = '6px';
            });
            skipLink.addEventListener('blur', () => {
                skipLink.style.top = '-40px';
            });
            document.body.insertBefore(skipLink, document.body.firstChild);

            // Add main content ID
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.id = 'main-content';
            }

            // Enhance form labels and ARIA attributes
            const forms = document.querySelectorAll('form, .input-section');
            forms.forEach(form => {
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (!input.getAttribute('aria-label') && !input.getAttribute('aria-labelledby')) {
                        const label = form.querySelector(`label[for="${input.id}"]`);
                        if (label) {
                            input.setAttribute('aria-labelledby', label.id || `label-${input.id}`);
                            if (!label.id) label.id = `label-${input.id}`;
                        }
                    }
                });
            });
        }

        // Initialize accessibility enhancements
        document.addEventListener('DOMContentLoaded', enhanceAccessibility);

        // Performance optimization
        function optimizePerformance() {
            // Lazy load table data
            const tables = document.querySelectorAll('table');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const table = entry.target;
                        if (table.dataset.loaded !== 'true') {
                            // Trigger data loading for visible tables
                            const tabContent = table.closest('.tab-content');
                            if (tabContent) {
                                const tabIndex = Array.from(tabContents).indexOf(tabContent);
                                if (tabIndex !== -1) {
                                    loadTabData(tabIndex);
                                    table.dataset.loaded = 'true';
                                }
                            }
                        }
                    }
                });
            });

            tables.forEach(table => observer.observe(table));
        }

        // Initialize performance optimizations
        setTimeout(optimizePerformance, 1000);

        // Enhanced error handling and logging
        window.addEventListener('error', (e) => {
            logActivity('javascript_error', `${e.message} at ${e.filename}:${e.lineno}`);
            console.error('Application error:', e);
        });

        window.addEventListener('unhandledrejection', (e) => {
            logActivity('promise_rejection', e.reason?.message || 'Unknown promise rejection');
            console.error('Unhandled promise rejection:', e);
        });

        // Service worker registration for offline capabilities (future enhancement)
        if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
            navigator.serviceWorker.register('/sw.js').then(() => {
                console.log('Service Worker registered successfully');
            }).catch((error) => {
                console.log('Service Worker registration failed:', error);
            });
        }

        // Progressive Web App features
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button
            const installButton = document.createElement('button');
            installButton.textContent = '📱 Installer l\'App';
            installButton.className = 'btn btn-info';
            installButton.style.position = 'fixed';
            installButton.style.bottom = '20px';
            installButton.style.right = '20px';
            installButton.style.zIndex = '1000';
            
            installButton.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    logActivity('pwa_install', choiceResult.outcome);
                    deferredPrompt = null;
                    installButton.remove();
                });
            });
            
            document.body.appendChild(installButton);
            
            // Auto-remove after 30 seconds
            setTimeout(() => {
                if (installButton.parentElement) {
                    installButton.remove();
                }
            }, 30000);
        });

        // Initialize pricing tiers on load
        document.addEventListener('DOMContentLoaded', () => {
            updatePricingTiers();
            
            // Set up form validation
            const forms = document.querySelectorAll('form, .input-section');
            forms.forEach(form => {
                const inputs = form.querySelectorAll('input[type="number"]');
                inputs.forEach(input => {
                    input.addEventListener('input', (e) => {
                        if (e.target.value < 0) {
                            e.target.setCustomValidity('La valeur ne peut pas être négative');
                        } else {
                            e.target.setCustomValidity('');
                        }
                    });
                });
            });
        });

        // Export functions for global access
        window.poultryApp = {
            switchTab,
            connectToSheets,
            saveDailyLog,
            saveInvestment,
            loadDashboardData,
            showAlert,
            logActivity,
            currentUser: () => currentUser,
            isConnected: () => isConnected
        };

        console.log('🐔 Système de Gestion Poulailler Pro initialisé avec succès!');
        console.log('📊 Fonctionnalités avancées: Authentication, Google Sheets, Analytics, Reports');
        console.log('🔒 Sécurité: Sessions, Logging, Validation, Accessibility');
    </script>
</body>
</html>